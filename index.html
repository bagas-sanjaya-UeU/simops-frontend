<!DOCTYPE html>
<html>

<head>
    <title>Sistem Izin Kerja K3 - SafetyFirst Academy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #1e3a5f;
            --primary-blue: #2c5282;
            --accent-orange: #e85a24;
            --light-bg: #f8fafc;
            --text-dark: #1a202c;
        }

        body {
            background-color: #f4f6f9;
            font-family: 'Poppins', 'Segoe UI', sans-serif;
            font-size: 0.9rem;
        }

        /* ================= LANDING PAGE STYLES ================= */
        .landing-page {
            background-color: var(--light-bg);
        }

        /* Top Navigation */
        .landing-navbar {
            background-color: var(--primary-dark);
            padding: 12px 0;
        }

        .landing-navbar .navbar-brand {
            color: white;
            font-weight: 700;
            font-size: 1.3rem;
        }

        .landing-navbar .navbar-brand i {
            color: #fbbf24;
        }

        .landing-navbar .nav-link {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.9rem;
            padding: 8px 16px;
        }

        .landing-navbar .nav-link:hover {
            color: white;
        }

        .btn-daftar {
            background-color: var(--accent-orange);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 500;
        }

        .btn-daftar:hover {
            background-color: #d14d1a;
            color: white;
        }

        /* Secondary Nav */
        .secondary-nav {
            background-color: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 10px 0;
        }

        .secondary-nav a {
            color: var(--text-dark);
            text-decoration: none;
            font-size: 0.9rem;
            margin-right: 30px;
        }

        .secondary-nav a:hover {
            color: var(--primary-blue);
        }

        .secondary-nav a.active-link {
            color: var(--primary-blue);
            font-weight: 600;
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 8px;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e6f0fa 100%);
            padding: 60px 0 40px;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: 50%;
            height: 100%;
            background: radial-gradient(ellipse at center right, rgba(186, 230, 253, 0.4) 0%, transparent 70%);
        }

        .hero-title {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--primary-dark);
            line-height: 1.2;
            margin-bottom: 20px;
        }

        .hero-subtitle {
            color: #64748b;
            font-size: 1rem;
            line-height: 1.7;
            margin-bottom: 30px;
        }

        .btn-mulai {
            background-color: var(--primary-dark);
            color: white;
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 500;
            border: none;
            margin-right: 12px;
        }

        .btn-mulai:hover {
            background-color: #152a45;
            color: white;
        }

        .btn-konsultasi {
            background-color: var(--accent-orange);
            color: white;
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 500;
            border: none;
        }

        .btn-konsultasi:hover {
            background-color: #d14d1a;
            color: white;
        }

        .hero-image {
            position: relative;
            z-index: 1;
        }

        .hero-image img {
            max-height: 320px;
            object-fit: contain;
        }

        /* Features Section */
        .features-section {
            padding: 50px 0;
            background-color: white;
        }

        .feature-card {
            text-align: center;
            padding: 30px 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .feature-card:hover {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            transform: translateY(-5px);
        }

        .feature-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feature-icon img {
            max-width: 100%;
            max-height: 100%;
        }

        .feature-icon i {
            font-size: 2.5rem;
            color: var(--accent-orange);
        }

        .feature-title {
            color: var(--accent-orange);
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .feature-desc {
            color: #64748b;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        /* Quote Section */
        .quote-section {
            padding: 40px 0;
            background-color: var(--light-bg);
        }

        .quote-box {
            background-color: white;
            border-radius: 12px;
            padding: 30px 40px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary-dark);
        }

        .quote-mark {
            color: var(--accent-orange);
            font-size: 3rem;
            font-family: Georgia, serif;
            line-height: 1;
        }

        .quote-text {
            color: var(--primary-dark);
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            font-style: italic;
        }

        /* Footer */
        .landing-footer {
            background-color: var(--primary-dark);
            color: white;
            padding: 25px 0;
        }

        .landing-footer a {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.2rem;
            margin-right: 15px;
        }

        .landing-footer a:hover {
            color: white;
        }

        .footer-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        .footer-copyright {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        /* ================= ORIGINAL APP STYLES ================= */
        .container {
            max-width: 1200px;
            margin-top: 20px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .page {
            display: none;
        }

        .active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .risk-low {
            background: #d1e7dd;
            color: #0f5132;
        }

        .risk-med {
            background: #fff3cd;
            color: #664d03;
        }

        .risk-high {
            background: #fd7e14;
            color: white;
        }

        .risk-ext {
            background: #dc3545;
            color: white;
        }

        .menu-card {
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #dee2e6;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            border-color: #0d6efd;
            box-shadow: 0 5px 15px rgba(13, 110, 253, 0.15);
        }

        .simops-conflict {
            border-left: 5px solid #dc3545;
            background-color: #fff5f5;
        }

        .activity-group {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .activity-header {
            background: #f8f9fa;
            padding: 10px 15px;
            font-weight: bold;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Hide app navbar on landing page */
        .app-navbar {
            display: none;
        }

        .app-container {
            display: none;
        }

        /* Show app when logged in */
        body.logged-in .landing-page {
            display: none !important;
        }

        body.logged-in .app-navbar {
            display: flex !important;
        }

        body.logged-in .app-container {
            display: block !important;
        }
    </style>
</head>

<body>

    <div id="loadingOverlay">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2 fw-bold text-secondary">Memproses...</div>
    </div>

    <!-- ================= LANDING PAGE ================= -->
    <div class="landing-page" id="landingPage">
        <!-- Top Navigation -->
        <nav class="landing-navbar">
            <div class="container-fluid px-4">
                <div class="d-flex justify-content-between align-items-center">
                    <a class="navbar-brand" href="#">
                        <i class="bi bi-person-badge-fill me-2"></i>SafetyFirst Academy
                    </a>
                    <div class="d-flex align-items-center gap-2">
                        <a href="#" class="nav-link d-none d-md-inline">Alat Pelindung Diri (APD)</a>
                        <a href="#" class="nav-link d-none d-md-inline">Sertifikasi</a>
                        <a href="#" class="nav-link d-none d-md-inline">Kontak</a>
                        <button class="btn btn-daftar" onclick="showLoginModal()">Daftar Sekarang</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Secondary Navigation -->
        <div class="secondary-nav">
            <div class="container-fluid px-4">
                <a href="#" class="active-link">Home</a>
                <a href="#">Pelatihan</a>
                <a href="#">Alat Pelindung Diri (APD)</a>
            </div>
        </div>

        <!-- Hero Section -->
        <section class="hero-section">
            <div class="container-fluid px-4">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <h1 class="hero-title">Keamanan Kerja Dimulai dari Diri Sendiri</h1>
                        <p class="hero-subtitle">
                            Edukasi K3 dengan cara yang lebih menyenangkan dan mudah dipahami untuk seluruh tim Anda
                        </p>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-mulai" onclick="showLoginModal()">Mulai Belajar</button>
                            <button class="btn btn-konsultasi">Konsultasi Gratis</button>
                        </div>
                    </div>
                    <div class="col-lg-6 text-center hero-image mt-4 mt-lg-0">
                        <div class="d-flex justify-content-center gap-3">
                            <!-- Placeholder for worker illustrations - replace with actual images -->
                            <img src="rudin1.png" alt="Safety Worker Female"
                                style="max-height: 1000px; object-fit: contain;"
                                onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22280%22><rect fill=%22%23f0f0f0%22 width=%22200%22 height=%22280%22/><text x=%2250%%22 y=%2250%%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2214%22>Worker Image</text></svg>'">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="features-section">
            <div class="container-fluid px-4">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="feature-card h-100">
                            <div class="feature-icon">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <h5 class="feature-title">Proteksi Maksimal</h5>
                            <p class="feature-desc">Panduan lengkap APD dan prosedur standar keselamatan internasional
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-card h-100">
                            <div class="feature-icon">
                                <i class="bi bi-play-circle"></i>
                            </div>
                            <h5 class="feature-title">Edukasi Interaktif</h5>
                            <p class="feature-desc">Materi safety yang tidak membosankan dengan ilustrasi menarik</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-card h-100">
                            <div class="feature-icon">
                                <i class="bi bi-award"></i>
                            </div>
                            <h5 class="feature-title">Sertifikasi Resmi</h5>
                            <p class="feature-desc">Pastikan tim Anda tersertifikasi dan patuh aturan keselamatan</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quote Section -->
        <section class="quote-section">
            <div class="container-fluid px-4">
                <div class="quote-box">
                    <div class="d-flex">
                        <span class="quote-mark">"</span>
                    </div>
                    <p class="quote-text">
                        "Ingat: Keselamatan adalah tanggung jawab bersama. Gunakan selalu masker respirator dan helm
                        pelindung di area kerja berbahaya"
                    </p>
                    <div class="d-flex justify-content-end">
                        <span class="quote-mark">"</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="landing-footer">
            <div class="container-fluid px-4">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <a href="#"><i class="bi bi-facebook"></i></a>
                        <a href="#"><i class="bi bi-twitter"></i></a>
                        <a href="#"><i class="bi bi-instagram"></i></a>
                        <a href="#"><i class="bi bi-linkedin"></i></a>
                    </div>
                    <div class="col-md-5 text-center">
                        <p class="footer-info mb-0">
                            Alamat Kantor: Jl. Keselamatan No. 123, Jakarta.<br>
                            Telepon: (021) 123-456
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <p class="footer-copyright mb-0">Copyright Â© 2026 SafetyFirst Academy</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title text-primary fw-bold">
                        <i class="bi bi-person-badge-fill me-2"></i>Login Sistem K3
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-3">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" id="u" class="form-control" placeholder="Masukkan username">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" id="p" class="form-control" placeholder="Masukkan password">
                    </div>
                    <button class="btn btn-primary w-100 py-2 fw-bold" onclick="login()">
                        <i class="bi bi-box-arrow-in-right me-2"></i>MASUK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= APP SECTION ================= -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3 shadow-sm px-3 rounded-bottom app-navbar">
        <a class="navbar-brand fw-bold" href="#"><i class="bi bi-cone-striped"></i> Izin Kerja K3</a>
        <div class="ms-auto d-flex align-items-center gap-3">
            <span class="text-white small">Halo, <span id="navUser" class="fw-bold">Guest</span> (<span
                    id="navRole"></span>)</span>
            <button class="btn btn-sm btn-outline-light" onclick="logout()">Keluar</button>
        </div>
    </nav>

    <div class="container app-container">

        <div id="page-dashboard" class="page">
            <h4 class="mb-4">Menu Utama</h4>
            <div class="row g-3" id="menuContainer"></div>
        </div>

        <div id="page-input" class="page">
            <h4><i class="bi bi-pencil-square"></i> Input Data Pekerjaan</h4>
            <hr>
            <form id="formJob">
                <div class="mb-2"><label class="fw-bold">Nama Perusahaan (PT)</label><input type="text" name="namaPT"
                        class="form-control" required></div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label>Kompartemen</label>
                        <select name="kompartemen" id="inKomp" class="form-select" onchange="setUnit()">
                            <option value="">- Pilih -</option>
                            <option value="Produksi 3A">Produksi 3A</option>
                            <option value="Produksi 3B">Produksi 3B</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label>Unit</label><select name="unit" id="inUnit" class="form-select" required>
                            <option value="">- Pilih Kompartemen Dulu -</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label>Jenis Pekerjaan</label>
                        <select name="jenisPekerjaan" class="form-select" required>
                            <option>Gabungan</option>
                            <option>Panas</option>
                            <option>Ketinggian</option>
                            <option>Penggalian</option>
                            <option>Lifting</option>
                            <option>Listrik</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-2"><label>Area Spesifik</label><input type="text" name="area"
                            class="form-control" required></div>
                </div>
                <div class="mb-2"><label>Nama Pekerjaan</label><input type="text" name="namaPekerjaan"
                        class="form-control" required></div>
                <div class="mb-2"><label>Penanggung Jawab (PJ)</label><input type="text" name="pjNama"
                        class="form-control" required></div>
                <div class="row">
                    <div class="col-md-4"><label>Tanggal</label><input type="date" name="tanggalKerja"
                            class="form-control" required></div>
                    <div class="col-md-4"><label>Jam Mulai</label><input type="time" name="jamMulai"
                            class="form-control" required></div>
                    <div class="col-md-4"><label>Jam Selesai</label><input type="time" name="jamSelesai"
                            class="form-control" required></div>
                </div>
                <br>
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" onclick="nav('page-dashboard')">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="submitJob()">Lanjut: Upload Dokumen <i
                            class="bi bi-arrow-right"></i></button>
                </div>
            </form>
        </div>

        <div id="page-upload" class="page">
            <h4><i class="bi bi-cloud-upload"></i> Upload Dokumen</h4>
            <div class="alert alert-info py-2">ID Pekerjaan: <strong id="lblJobId">...</strong></div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="chkLanjutan" onchange="toggleDocs()">
                <label class="form-check-label fw-bold" for="chkLanjutan">Pekerjaan Lanjutan (Hanya Wajib WP)</label>
            </div>

            <ul class="list-group mb-4">
                <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                    <div><strong>1. Work Permit (WP)</strong> <span class="badge bg-danger">Wajib</span></div>
                    <div><input type="file" id="f_WP" hidden
                            onchange="uploadFile('Work Permit','f_WP','btn_WP')"><button id="btn_WP"
                            class="btn btn-sm btn-outline-danger"
                            onclick="document.getElementById('f_WP').click()">Upload WP</button></div>
                </li>
                <div id="optDocs">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>2. JSA</div>
                        <div><input type="file" id="f_JSA" hidden onchange="uploadFile('JSA','f_JSA','btn_JSA')"><button
                                id="btn_JSA" class="btn btn-sm btn-outline-primary"
                                onclick="document.getElementById('f_JSA').click()">Upload</button></div>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>3. PJA</div>
                        <div><input type="file" id="f_PJA" hidden onchange="uploadFile('PJA','f_PJA','btn_PJA')"><button
                                id="btn_PJA" class="btn btn-sm btn-outline-primary"
                                onclick="document.getElementById('f_PJA').click()">Upload</button></div>
                    </li>
                </div>
            </ul>
            <button id="btnToRisk" class="btn btn-success w-100" onclick="nav('page-risk-input')">Lanjut: Penilaian
                Risiko <i class="bi bi-arrow-right"></i></button>
            <button id="btnBackToAdmin" class="btn btn-secondary w-100 mt-2" style="display:none"
                onclick="nav('page-list-admin')">Kembali ke List</button>
        </div>

        <div id="page-risk-input" class="page">
            <h4><i class="bi bi-shield-exclamation"></i> Penilaian Risiko (Risk Assessment)</h4>
            <div class="alert alert-warning small">
                Gunakan skala 1-5 untuk Kemungkinan & Dampak. Sistem menghitung Tingkat Risiko otomatis.
            </div>

            <div id="riskContainer"></div>

            <button class="btn btn-outline-primary w-100 mb-4 border-dashed" onclick="addActivityBlock()">
                <i class="bi bi-plus-circle"></i> Tambah Aktivitas Baru
            </button>

            <button class="btn btn-warning w-100 fw-bold py-2" onclick="submitRisk()">SIMPAN PENILAIAN SELESAI</button>
            <button class="btn btn-light w-100 mt-2" onclick="nav('page-dashboard')">Batal</button>
        </div>

        <div id="page-rekap" class="page">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="bi bi-list-check"></i> Monitoring & SIMOPS</h4>
                <button class="btn btn-secondary btn-sm" onclick="nav('page-dashboard')">Kembali</button>
            </div>
            <div id="simopsContainer"></div>
            <div id="rekapContainer" class="row g-3">Loading...</div>
        </div>

        <div id="page-list-admin" class="page">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="bi bi-folder2-open"></i> Data Pekerjaan</h4>
                <button class="btn btn-secondary btn-sm" onclick="nav('page-dashboard')">Kembali</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-bordered bg-white">
                    <thead class="table-dark">
                        <tr>
                            <th>Tanggal</th>
                            <th>PT / Pekerjaan</th>
                            <th>Status Doc</th>
                            <th>Status Risk</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="adminListBody"></tbody>
                </table>
            </div>
        </div>

        <div id="page-user" class="page">
            <h4>Tambah User Baru</h4>
            <form id="formUser">
                <div class="mb-2"><label>Username</label><input type="text" name="regUser" class="form-control"></div>
                <div class="mb-2"><label>Password</label><input type="text" name="regPass" class="form-control"></div>
                <div class="mb-2"><label>Role</label>
                    <select name="regRole" class="form-select">
                        <option value="Staff">Pekerja (Staff)</option>
                        <option value="Admin">Safety/Admin</option>
                        <option value="Inspector">Inspector</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary mt-2" onclick="submitUser()">Buat Akun</button>
                <button type="button" class="btn btn-light mt-2" onclick="nav('page-dashboard')">Kembali</button>
            </form>
        </div>

        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Detail Pekerjaan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="modalContent"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==========================================================
        // KONFIGURASI BACKEND (GANTI DENGAN URL RENDER ANDA)
        // ==========================================================
        const API_BASE_URL = "https://simops-backend.onrender.com";
        // ==========================================================

        let currUser = { name: '', role: '' };
        let currJobId = '';
        let allJobsCache = [];
        let loginModal;

        const units = {
            "Produksi 3A": ["Asam Sulfat", "Asam Fosfat", "ZAII", "Purifikasi", "ET"],
            "Produksi 3B": ["Asam Sulfat", "Asam Fosfat", "Purifikasi", "ALF3", "UBB"]
        };

        const optProb = [{ v: 1, t: "1 - Sangat Jarang" }, { v: 2, t: "2 - Jarang" }, { v: 3, t: "3 - Mungkin" }, { v: 4, t: "4 - Mungkin Sekali" }, { v: 5, t: "5 - Hampir Pasti" }];
        const optImp = [{ v: 1, t: "1 - Tidak Signifikan" }, { v: 2, t: "2 - Kecil" }, { v: 3, t: "3 - Sedang" }, { v: 4, t: "4 - Besar" }, { v: 5, t: "5 - Bencana" }];

        // --- UTILS ---
        const showLoading = () => document.getElementById('loadingOverlay').style.display = 'flex';
        const hideLoading = () => document.getElementById('loadingOverlay').style.display = 'none';

        // Initialize modal on page load
        document.addEventListener('DOMContentLoaded', function () {
            loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        });

        function showLoginModal() {
            loginModal.show();
        }

        function nav(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            if (page === 'page-rekap') loadRekap();
            if (page === 'page-list-admin') loadAdminList();
        }

        // --- AUTHENTICATION ---
        async function login() {
            const u = document.getElementById('u').value;
            const p = document.getElementById('p').value;

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();

                if (res.ok && data.status === 'Sukses') {
                    currUser = { name: u, role: data.role };
                    document.getElementById('navUser').innerText = u;
                    document.getElementById('navRole').innerText = data.role;

                    // Hide login modal if open
                    if (loginModal) loginModal.hide();

                    // Switch to app view
                    document.body.classList.add('logged-in');

                    setupMenu();
                    nav('page-dashboard');
                } else {
                    alert('Login Gagal: ' + (data.message || 'Error'));
                }
            } catch (err) {
                alert('Gagal koneksi ke server: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        function logout() {
            currUser = {};
            document.getElementById('u').value = '';
            document.getElementById('p').value = '';

            // Switch back to landing page
            document.body.classList.remove('logged-in');

            // Hide all app pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        }

        function setupMenu() {
            const c = document.getElementById('menuContainer');
            let html = '';
            if (currUser.role === 'Staff') {
                html += `<div class="col-md-4"><div class="card menu-card p-4 text-center" onclick="nav('page-input')"><i class="bi bi-pencil-square fs-1 text-primary"></i><h5 class="mt-2">Input Pekerjaan</h5></div></div>`;
            }
            if (currUser.role === 'Admin' || currUser.role === 'Inspector') {
                html += `<div class="col-md-4"><div class="card menu-card p-4 text-center" onclick="nav('page-list-admin')"><i class="bi bi-folder2-open fs-1 text-primary"></i><h5 class="mt-2">Data Pekerjaan & Dokumen</h5></div></div>`;
            }
            html += `<div class="col-md-4"><div class="card menu-card p-4 text-center" onclick="nav('page-rekap')"><i class="bi bi-table fs-1 text-success"></i><h5 class="mt-2">Rekap & SIMOPS</h5></div></div>`;
            if (currUser.role === 'Admin') {
                html += `<div class="col-md-4"><div class="card menu-card p-4 text-center" onclick="nav('page-user')"><i class="bi bi-person-plus fs-1 text-warning"></i><h5 class="mt-2">Tambah User</h5></div></div>`;
            }
            c.innerHTML = html;
        }

        function setUnit() {
            const k = document.getElementById('inKomp').value;
            const u = document.getElementById('inUnit');
            u.innerHTML = '<option value="">- Pilih -</option>';
            if (units[k]) units[k].forEach(x => { u.innerHTML += `<option>${x}</option>`; });
        }

        // --- SUBMIT JOB ---
        async function submitJob() {
            const form = document.getElementById('formJob');
            if (!form.reportValidity()) return;

            const formData = new FormData(form);
            const jsonData = Object.fromEntries(formData.entries());

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/jobs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonData)
                });
                const data = await res.json();

                if (res.ok) {
                    currJobId = data.id;
                    document.getElementById('lblJobId').innerText = data.id;
                    form.reset();
                    document.getElementById('btnToRisk').style.display = 'block';
                    document.getElementById('btnBackToAdmin').style.display = 'none';
                    nav('page-upload');
                } else {
                    alert('Gagal simpan data: ' + data.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        function toggleDocs() {
            const chk = document.getElementById('chkLanjutan');
            document.getElementById('optDocs').style.display = chk.checked ? 'none' : 'block';
        }

        // --- UPLOAD FILE ---
        async function uploadFile(jenis, inpId, btnId) {
            const f = document.getElementById(inpId).files[0];
            if (!f) return;

            const btn = document.getElementById(btnId);
            btn.innerText = 'Uploading...'; btn.disabled = true;

            const formData = new FormData();
            formData.append('file', f);
            formData.append('idPekerjaan', currJobId);
            formData.append('jenisDokumen', jenis);

            try {
                const res = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (res.ok) {
                    alert('Upload Berhasil!');
                    btn.className = 'btn btn-sm btn-success'; btn.innerText = 'OK';
                } else {
                    alert('Gagal: ' + data.error);
                    btn.innerText = 'Coba Lagi'; btn.disabled = false;
                }
            } catch (err) {
                alert('Error: ' + err.message);
                btn.innerText = 'Error'; btn.disabled = false;
            }
        }

        // --- RISK ASSESMENT UI ---
        function addActivityBlock() {
            const div = document.createElement('div');
            div.className = 'activity-group bg-white';
            div.innerHTML = `
            <div class="activity-header">
                <input type="text" class="form-control form-control-sm me-2 act-name" placeholder="Nama Aktivitas" style="max-width:300px">
                <button class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()"><i class="bi bi-trash"></i></button>
            </div>
            <div class="p-2">
                <table class="table table-sm table-bordered mb-2">
                    <thead class="table-light"><tr><th>Bahaya</th><th width="120">Kemungkinan</th><th width="120">Dampak</th><th width="80">Risiko</th><th width="30"></th></tr></thead>
                    <tbody class="hazard-body"></tbody>
                </table>
                <button class="btn btn-sm btn-outline-success" onclick="addHazardRow(this)"><i class="bi bi-plus"></i> Tambah Bahaya</button>
            </div>`;
            document.getElementById('riskContainer').appendChild(div);
            addHazardRow(div.querySelector('.btn-outline-success'));
        }

        function addHazardRow(btn) {
            const tbody = btn.previousElementSibling.querySelector('tbody');
            const tr = document.createElement('tr');
            let optP = optProb.map(o => `<option value="${o.v} - ${o.t}">${o.t}</option>`).join('');
            let optI = optImp.map(o => `<option value="${o.v} - ${o.t}">${o.t}</option>`).join('');

            tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm haz"></td>
            <td><select class="form-select form-select-sm l" onchange="calcRR(this)">${optP}</select></td>
            <td><select class="form-select form-select-sm c" onchange="calcRR(this)">${optI}</select></td>
            <td><input type="text" class="form-control form-control-sm rr fw-bold text-center" readonly value="1"></td>
            <td><i class="bi bi-x text-danger" style="cursor:pointer" onclick="this.closest('tr').remove()"></i></td>`;
            tbody.appendChild(tr);
        }

        function calcRR(el) {
            const row = el.closest('tr');
            const l = parseInt(row.querySelector('.l').value);
            const c = parseInt(row.querySelector('.c').value);
            row.querySelector('.rr').value = l * c;
        }

        async function submitRisk() {
            let dataRisiko = [];
            document.querySelectorAll('.activity-group').forEach(group => {
                let actName = group.querySelector('.act-name').value;
                group.querySelectorAll('tbody tr').forEach(tr => {
                    dataRisiko.push({
                        aktivitas: actName,
                        bahaya: tr.querySelector('.haz').value,
                        l: tr.querySelector('.l').value,
                        c: tr.querySelector('.c').value,
                        rr: tr.querySelector('.rr').value
                    });
                });
            });

            if (dataRisiko.length === 0) return alert("Isi minimal satu aktivitas!");

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/risks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idPekerjaan: currJobId, dataRisiko })
                });
                if (res.ok) {
                    alert('Data Berhasil Disimpan!');
                    document.getElementById('riskContainer').innerHTML = '';
                    nav('page-dashboard');
                } else {
                    alert('Gagal simpan risiko');
                }
            } catch (err) { alert(err.message); }
            finally { hideLoading(); }
        }

        // --- ADMIN FEATURES ---
        async function submitUser() {
            const form = document.getElementById('formUser');
            const formData = new FormData(form);
            const jsonData = Object.fromEntries(formData.entries());

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/register`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(jsonData)
                });
                const data = await res.json();
                alert(data.message);
                if (res.ok) form.reset();
            } catch (e) { alert(e.message); }
            finally { hideLoading(); }
        }

        async function loadAdminList() {
            document.getElementById('adminListBody').innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';
            try {
                const res = await fetch(`${API_BASE_URL}/api/rekap`);
                const jobs = await res.json();
                renderAdminList(jobs);
            } catch (e) {
                document.getElementById('adminListBody').innerHTML = '<tr><td colspan="5" class="text-danger">Gagal load data</td></tr>';
            }
        }

        function renderAdminList(jobs) {
            allJobsCache = jobs || [];
            const tbody = document.getElementById('adminListBody');
            tbody.innerHTML = '';

            if (jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Belum ada data.</td></tr>';
                return;
            }

            jobs.forEach(j => {
                let btnAction = `<button class="btn btn-sm btn-info text-white" onclick="showDetail('${j.id}')">Detail & Docs</button>`;
                tbody.innerHTML += `<tr>
                <td>${j.tanggal}<br><small>${j.jamMulai}-${j.jamSelesai}</small></td>
                <td><strong>${j.namaPT}</strong><br>${j.pekerjaan}</td>
                <td>${j.statusDoc}</td>
                <td>${j.statusRisk}</td>
                <td>${btnAction}</td>
             </tr>`;
            });
        }

        function showDetail(id) {
            const j = allJobsCache.find(x => x.id === id);
            if (!j) return;
            currJobId = id;

            let docsHtml = '<ul class="list-group mb-3">';
            if (j.docs.length > 0) {
                j.docs.forEach(d => {
                    docsHtml += `<li class="list-group-item d-flex justify-content-between"><span>${d.jenis}</span><a href="${d.url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i> Lihat</a></li>`;
                });
            } else { docsHtml += '<li class="list-group-item text-muted">Belum ada dokumen</li>'; }
            docsHtml += '</ul>';

            docsHtml += `<button class="btn btn-sm btn-secondary mb-3" onclick="document.getElementById('lblJobId').innerText='${id}'; document.getElementById('btnToRisk').style.display='none'; document.getElementById('btnBackToAdmin').style.display='block'; nav('page-upload'); bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide(); ">+ Upload Dokumen Tambahan</button>`;

            let approveBtn = '';
            if (currUser.role === 'Inspector' && j.statusDoc !== 'APPROVED') {
                approveBtn = `<button class="btn btn-success w-100 mb-3" onclick="doApprove('${id}')"><i class="bi bi-check-circle"></i> APPROVE DOKUMEN</button>`;
            }

            let riskHtml = '<table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Akt</th><th>Bahaya</th><th>L</th><th>C</th><th>RR</th></tr></thead><tbody>';
            if (j.riskData && j.riskData.details) {
                j.riskData.details.forEach(r => {
                    riskHtml += `<tr><td>${r.act}</td><td>${r.hazard}</td><td>${r.l}</td><td>${r.c}</td><td class="fw-bold">${r.rr}</td></tr>`;
                });
            }
            riskHtml += '</tbody></table>';

            const content = `<h6>Informasi Pekerjaan</h6><p><strong>${j.namaPT}</strong> - ${j.pekerjaan} (${j.area})</p><hr><h6>Dokumen</h6>${docsHtml}${approveBtn}<hr><h6>Penilaian Risiko</h6>${riskHtml}`;
            document.getElementById('modalContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        async function doApprove(id) {
            if (!confirm('Setujui dokumen pekerjaan ini?')) return;
            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/jobs/${id}/approve`, { method: 'PUT' });
                const data = await res.json();
                alert(data.message);
                loadAdminList();
                bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
            } catch (e) { alert(e.message); }
            finally { hideLoading(); }
        }

        // --- REKAP & SIMOPS (Load Data) ---
        async function loadRekap() {
            document.getElementById('rekapContainer').innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary"></div><p>Sedang memuat data...</p></div>';
            try {
                const res = await fetch(`${API_BASE_URL}/api/rekap`);
                const jobs = await res.json();
                renderRekap(jobs);
            } catch (err) {
                document.getElementById('rekapContainer').innerHTML = `<div class="alert alert-danger">Gagal mengambil data dari server: ${err.message}</div>`;
            }
        }

        function isOverlap(t1S, t1E, t2S, t2E) {
            if (!t1S || !t1E || !t2S || !t2E) return false;
            try {
                const toM = t => parseInt(t.split(':')[0]) * 60 + parseInt(t.split(':')[1]);
                let s1 = toM(t1S), e1 = toM(t1E);
                let s2 = toM(t2S), e2 = toM(t2E);
                if (e1 < s1) e1 += 24 * 60;
                if (e2 < s2) e2 += 24 * 60;
                return (s1 < e2 && e1 > s2);
            } catch (e) { return false; }
        }

        function renderRekap(jobs) {
            if (!jobs || !Array.isArray(jobs) || jobs.length === 0) {
                document.getElementById('rekapContainer').innerHTML = '<div class="alert alert-info">Belum ada data pekerjaan yang tercatat.</div>';
                document.getElementById('simopsContainer').innerHTML = '';
                return;
            }

            let areas = {};
            jobs.forEach(j => {
                let areaName = j.area || "Area Umum";
                if (!areas[areaName]) areas[areaName] = [];
                areas[areaName].push(j);
            });

            let html = '';
            let simopsHtml = '';

            for (const [area, areaJobs] of Object.entries(areas)) {
                let conflict = false;
                let conflictJobs = [];

                for (let i = 0; i < areaJobs.length; i++) {
                    for (let j = i + 1; j < areaJobs.length; j++) {
                        if (isOverlap(areaJobs[i].jamMulai, areaJobs[i].jamSelesai, areaJobs[j].jamMulai, areaJobs[j].jamSelesai)) {
                            conflict = true;
                            if (!conflictJobs.includes(areaJobs[i])) conflictJobs.push(areaJobs[i]);
                            if (!conflictJobs.includes(areaJobs[j])) conflictJobs.push(areaJobs[j]);
                        }
                    }
                }

                html += `<div class="col-12 mt-3"><h5 class="border-bottom pb-2 text-primary">${area}</h5></div>`;

                areaJobs.forEach(job => {
                    let isConflict = conflictJobs.includes(job);
                    let borderClass = isConflict ? 'border-danger border-2' : 'border-light shadow-sm';

                    html += `<div class="col-md-4 mb-3"><div class="card h-100 ${borderClass}"><div class="card-body">
                  <h6 class="fw-bold">${job.jenis} - ${job.pekerjaan}</h6>
                  <div class="mb-1 text-primary fw-bold small"><i class="bi bi-building"></i> ${job.namaPT}</div>
                  <small class="badge bg-secondary"><i class="bi bi-clock"></i> ${job.jamMulai} - ${job.jamSelesai}</small>
                  <div class="mt-2 small border-top pt-2">
                    <span class="d-block"><strong>Dokumen:</strong> ${job.statusDoc}</span>
                    <span class="d-block"><strong>Risiko:</strong> L=${job.riskData.maxL}, C=${job.riskData.maxC}</span>
                  </div></div></div></div>`;
                });

                if (conflict) {
                    let maxL = 0, maxC = 0;
                    conflictJobs.forEach(j => {
                        if (j.riskData.maxL > maxL) maxL = j.riskData.maxL;
                        if (j.riskData.maxC > maxC) maxC = j.riskData.maxC;
                    });
                    let combinedRR = maxL * maxC;

                    simopsHtml += `<div class="alert alert-danger border-danger border-3 mb-3">
               <h5 class="fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> SIMOPS Terdeteksi: ${area}</h5>
               <p class="mb-2">Konflik jadwal antara:</p>
               <ul class="mb-2 small">${conflictJobs.map(j => `<li><strong>${j.namaPT}</strong>: ${j.pekerjaan} (${j.jamMulai}-${j.jamSelesai})</li>`).join('')}</ul>
               <div class="d-flex align-items-center gap-2 bg-white p-2 rounded border">
                  <small class="fw-bold text-muted">RISIKO GABUNGAN:</small><span class="badge bg-light text-dark border">Max L: ${maxL}</span><span class="text-muted">x</span><span class="badge bg-light text-dark border">Max C: ${maxC}</span><span class="text-muted">=</span><span class="badge bg-danger fs-6">RR: ${combinedRR}</span>
               </div></div>`;
                }
            }
            document.getElementById('rekapContainer').innerHTML = html;
            document.getElementById('simopsContainer').innerHTML = simopsHtml || '<div class="alert alert-success border-success"><i class="bi bi-check-circle-fill"></i> Tidak ada konflik SIMOPS terdeteksi.</div>';
        }
    </script>
</body>

</html>