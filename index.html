<!DOCTYPE html>
<html>

<head>
    <title>SIMOPS K3 - Sistem Manajemen Operasi Simultan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #1e3a5f;
            --primary-blue: #2c5282;
            --accent-orange: #e85a24;
            --light-bg: #f8fafc;
            --text-dark: #1a202c;
        }

        body {
            background-color: #f4f6f9;
            font-family: 'Poppins', 'Segoe UI', sans-serif;
            font-size: 0.9rem;
        }

        /* ================= LANDING PAGE STYLES ================= */
        .landing-page {
            background-color: var(--light-bg);
        }

        /* Top Navigation */
        .landing-navbar {
            background-color: var(--primary-dark);
            padding: 12px 0;
        }

        .landing-navbar .navbar-brand {
            color: white;
            font-weight: 700;
            font-size: 1.3rem;
        }

        .landing-navbar .navbar-brand i {
            color: #fbbf24;
        }

        .landing-navbar .nav-link {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.9rem;
            padding: 8px 16px;
        }

        .landing-navbar .nav-link:hover {
            color: white;
        }

        .btn-daftar {
            background-color: var(--accent-orange);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 500;
        }

        .btn-daftar:hover {
            background-color: #d14d1a;
            color: white;
        }

        /* Secondary Nav */
        .secondary-nav {
            background-color: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 10px 0;
        }

        .secondary-nav a {
            color: var(--text-dark);
            text-decoration: none;
            font-size: 0.9rem;
            margin-right: 30px;
        }

        .secondary-nav a:hover {
            color: var(--primary-blue);
        }

        .secondary-nav a.active-link {
            color: var(--primary-blue);
            font-weight: 600;
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 8px;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e6f0fa 100%);
            padding: 60px 0 40px;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: 50%;
            height: 100%;
            background: radial-gradient(ellipse at center right, rgba(186, 230, 253, 0.4) 0%, transparent 70%);
        }

        .hero-title {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--primary-dark);
            line-height: 1.2;
            margin-bottom: 20px;
        }

        .hero-subtitle {
            color: #64748b;
            font-size: 1rem;
            line-height: 1.7;
            margin-bottom: 30px;
        }

        .btn-mulai {
            background-color: var(--primary-dark);
            color: white;
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 500;
            border: none;
            margin-right: 12px;
        }

        .btn-mulai:hover {
            background-color: #152a45;
            color: white;
        }

        .btn-konsultasi {
            background-color: var(--accent-orange);
            color: white;
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 500;
            border: none;
        }

        .btn-konsultasi:hover {
            background-color: #d14d1a;
            color: white;
        }

        .hero-image {
            position: relative;
            z-index: 1;
        }

        .hero-image img {
            max-height: 320px;
            object-fit: contain;
        }

        /* Features Section */
        .features-section {
            padding: 50px 0;
            background-color: white;
        }

        .feature-card {
            text-align: center;
            padding: 30px 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .feature-card:hover {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            transform: translateY(-5px);
        }

        .feature-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feature-icon img {
            max-width: 100%;
            max-height: 100%;
        }

        .feature-icon i {
            font-size: 2.5rem;
            color: var(--accent-orange);
        }

        .feature-title {
            color: var(--accent-orange);
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .feature-desc {
            color: #64748b;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        /* Quote Section */
        .quote-section {
            padding: 40px 0;
            background-color: var(--light-bg);
        }

        .quote-box {
            background-color: white;
            border-radius: 12px;
            padding: 30px 40px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary-dark);
        }

        .quote-mark {
            color: var(--accent-orange);
            font-size: 3rem;
            font-family: Georgia, serif;
            line-height: 1;
        }

        .quote-text {
            color: var(--primary-dark);
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            font-style: italic;
        }

        /* Footer */
        .landing-footer {
            background-color: var(--primary-dark);
            color: white;
            padding: 25px 0;
        }

        .landing-footer a {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.2rem;
            margin-right: 15px;
        }

        .landing-footer a:hover {
            color: white;
        }

        .footer-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        .footer-copyright {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        /* ================= ORIGINAL APP STYLES ================= */
        .container {
            max-width: 1200px;
            margin-top: 20px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .page {
            display: none;
        }

        .active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .risk-low {
            background: #d1e7dd;
            color: #0f5132;
        }

        .risk-med {
            background: #fff3cd;
            color: #664d03;
        }

        .risk-high {
            background: #fd7e14;
            color: white;
        }

        .risk-ext {
            background: #dc3545;
            color: white;
        }

        .menu-card {
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #dee2e6;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            border-color: #0d6efd;
            box-shadow: 0 5px 15px rgba(13, 110, 253, 0.15);
        }

        .simops-conflict {
            border-left: 5px solid #dc3545;
            background-color: #fff5f5;
        }

        .activity-group {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .activity-header {
            background: #f8f9fa;
            padding: 10px 15px;
            font-weight: bold;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Hide app navbar on landing page */
        .app-navbar {
            display: none;
        }

        .app-container {
            display: none;
        }

        /* Show app when logged in */
        body.logged-in .landing-page {
            display: none !important;
        }

        body.logged-in .app-navbar {
            display: flex !important;
        }

        body.logged-in .app-container {
            display: block !important;
        }

        /* ================= ANIMATIONS ================= */

        /* Keyframes */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-80px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-60px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(60px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }

            50% {
                transform: scale(1.05);
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes rotateIn {
            from {
                opacity: 0;
                transform: rotate(-10deg) scale(0.9);
            }

            to {
                opacity: 1;
                transform: rotate(0) scale(1);
            }
        }

        /* Navbar Animation */
        .landing-navbar {
            animation: slideDown 0.6s ease-out;
        }

        .landing-navbar .navbar-brand {
            animation: slideInLeft 0.8s ease-out 0.2s both;
        }

        .landing-navbar .navbar-brand i {
            display: inline-block;
            animation: pulse 2s ease-in-out infinite;
        }

        /* Hero Section Animations */
        .hero-title {
            animation: slideInLeft 0.8s ease-out 0.3s both;
        }

        .hero-subtitle {
            animation: slideInLeft 0.8s ease-out 0.5s both;
        }

        .hero-section .btn-mulai,
        .hero-section .btn-konsultasi {
            animation: slideUp 0.6s ease-out 0.7s both;
        }

        .hero-section .btn-konsultasi {
            animation-delay: 0.8s;
        }

        /* Hero Image - Slide from Top to Bottom */
        .hero-image img,
        .hero-img-animated {
            animation: slideDown 1s ease-out 0.4s both;
        }

        .hero-image img:hover,
        .hero-img-animated:hover {
            animation: slideDown 1s ease-out 0.4s both, float 3s ease-in-out 1.4s infinite;
        }

        /* Additional hover effect for hero image */
        .hero-img-animated {
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .hero-img-animated:hover {
            filter: drop-shadow(0 20px 40px rgba(30, 58, 95, 0.3));
        }

        /* Feature Cards Animation */
        .feature-card {
            animation: slideUp 0.7s ease-out both;
            opacity: 0;
        }

        .features-section .col-md-4:nth-child(1) .feature-card {
            animation-delay: 0.2s;
        }

        .features-section .col-md-4:nth-child(2) .feature-card {
            animation-delay: 0.4s;
        }

        .features-section .col-md-4:nth-child(3) .feature-card {
            animation-delay: 0.6s;
        }

        .feature-icon i {
            transition: all 0.4s ease;
        }

        .feature-card:hover .feature-icon i {
            transform: scale(1.2) rotate(5deg);
            color: var(--primary-dark);
        }

        /* Quote Section Animation */
        .quote-box {
            animation: scaleIn 0.8s ease-out 0.3s both;
        }

        .quote-mark {
            display: inline-block;
            animation: bounceIn 0.8s ease-out 0.5s both;
        }

        .quote-text {
            animation: slideUp 0.8s ease-out 0.6s both;
        }

        /* Footer Animation */
        .landing-footer {
            animation: slideUp 0.6s ease-out;
        }

        .landing-footer a {
            display: inline-block;
            transition: all 0.3s ease;
        }

        .landing-footer a:hover {
            transform: translateY(-5px) scale(1.2);
        }

        /* Button Hover Effects */
        .btn-mulai,
        .btn-konsultasi,
        .btn-daftar {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn-mulai::before,
        .btn-konsultasi::before,
        .btn-daftar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-mulai:hover::before,
        .btn-konsultasi:hover::before,
        .btn-daftar:hover::before {
            left: 100%;
        }

        .btn-mulai:hover,
        .btn-konsultasi:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        /* Menu Card Animations (App Section) */
        .menu-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .menu-card:hover {
            transform: translateY(-10px) scale(1.02);
        }

        .menu-card i {
            transition: all 0.4s ease;
        }

        .menu-card:hover i {
            transform: scale(1.2);
        }

        /* Modal Animation Enhancement */
        .modal.fade .modal-dialog {
            transform: scale(0.8) translateY(-50px);
            transition: all 0.3s ease-out;
        }

        .modal.show .modal-dialog {
            transform: scale(1) translateY(0);
        }

        /* Loading Overlay Animation */
        #loadingOverlay .spinner-border {
            animation: spin 1s linear infinite, pulse 1.5s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Alert/Badge Animation */
        .badge.bg-danger {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Form Input Focus Animation */
        .form-control,
        .form-select {
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            transform: scale(1.01);
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.2);
        }

        /* App Navbar Animation */
        .app-navbar {
            animation: slideDown 0.5s ease-out;
        }

        /* Table Row Hover Animation */
        .table tbody tr {
            transition: all 0.3s ease;
        }

        .table tbody tr:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Activity Group Animation */
        .activity-group {
            animation: slideInLeft 0.4s ease-out;
        }

        /* Scroll Animation Trigger Class */
        .animate-on-scroll {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s ease-out;
        }

        .animate-on-scroll.animated {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>

<body>

    <div id="loadingOverlay">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2 fw-bold text-secondary">Memproses...</div>
    </div>

    <!-- ================= LANDING PAGE ================= -->
    <div class="landing-page" id="landingPage">
        <!-- Top Navigation -->
        <nav class="landing-navbar">
            <div class="container-fluid px-4">
                <div class="d-flex justify-content-between align-items-center">
                    <a class="navbar-brand" href="#">
                        <i class="bi bi-person-badge-fill me-2"></i>SIMOPS K3
                    </a>
                    <div class="d-flex align-items-center gap-2">
                        <a href="#" class="nav-link d-none d-md-inline">Kontak</a>
                        <button class="btn btn-outline-light btn-sm me-2" onclick="showRegisterModal()">Daftar</button>
                        <button class="btn btn-daftar" onclick="showLoginModal()">Masuk</button>
                    </div>
                </div>
            </div>
        </nav>


        <!-- Hero Section -->
        <section class="hero-section">
            <div class="container-fluid px-4">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <h1 class="hero-title">Kelola Operasi Simultan dengan Aman & Terkendali</h1>
                        <p class="hero-subtitle">
                            Sistem manajemen SIMOPS K3 untuk mengidentifikasi, menganalisis, dan mengendalikan risiko
                            pekerjaan simultan di area kerja Anda
                        </p>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-mulai" onclick="showLoginModal()">Masuk Sistem</button>
                            <button class="btn btn-konsultasi">Pelajari SIMOPS</button>
                        </div>
                    </div>
                    <div class="col-lg-6 text-center hero-image mt-4 mt-lg-0">
                        <div class="d-flex justify-content-center gap-3">
                            <!-- Placeholder for worker illustrations - replace with actual images -->
                            <img src="rudin1.png" alt="Safety Worker Female" class="hero-img-animated"
                                style="max-height: 500px; object-fit: contain;"
                                onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22280%22><rect fill=%22%23f0f0f0%22 width=%22200%22 height=%22280%22/><text x=%2250%%22 y=%2250%%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2214%22>Worker Image</text></svg>'">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="features-section">
            <div class="container-fluid px-4">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="feature-card h-100">
                            <div class="feature-icon">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <h5 class="feature-title">Deteksi Konflik Otomatis</h5>
                            <p class="feature-desc">Sistem otomatis mendeteksi tumpang tindih jadwal dan area pekerjaan
                                untuk mencegah insiden
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-card h-100">
                            <div class="feature-icon">
                                <i class="bi bi-graph-up-arrow"></i>
                            </div>
                            <h5 class="feature-title">Penilaian Risiko Terintegrasi</h5>
                            <p class="feature-desc">Analisis risiko gabungan untuk pekerjaan simultan dengan perhitungan
                                otomatis</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-card h-100">
                            <div class="feature-icon">
                                <i class="bi bi-speedometer2"></i>
                            </div>
                            <h5 class="feature-title">Monitoring Real-Time</h5>
                            <p class="feature-desc">Pantau seluruh izin kerja dan status dokumen secara real-time dalam
                                satu dashboard</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quote Section -->
        <section class="quote-section">
            <div class="container-fluid px-4">
                <div class="quote-box animate-on-scroll">
                    <div class="d-flex">
                        <span class="quote-mark">"</span>
                    </div>
                    <p class="quote-text">
                        "SIMOPS yang baik bukan hanya tentang menghindari tabrakan jadwal, tapi memastikan setiap
                        pekerjaan berjalan aman tanpa mengganggu pekerjaan lainnya"
                    </p>
                    <div class="d-flex justify-content-end">
                        <span class="quote-mark">"</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="landing-footer">
            <div class="container-fluid px-4">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <a href="#"><i class="bi bi-facebook"></i></a>
                        <a href="#"><i class="bi bi-twitter"></i></a>
                        <a href="#"><i class="bi bi-instagram"></i></a>
                        <a href="#"><i class="bi bi-linkedin"></i></a>
                    </div>
                    <div class="col-md-5 text-center">
                        <p class="footer-info mb-0">
                            Sistem Manajemen Operasi Simultan K3<br>
                            Keselamatan & Kesehatan Kerja
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <p class="footer-copyright mb-0">Copyright Â© 2026 SIMOPS K3 System</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title text-primary fw-bold">
                        <i class="bi bi-person-badge-fill me-2"></i>Login Sistem K3
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-3">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" id="u" class="form-control" placeholder="Masukkan username">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" id="p" class="form-control" placeholder="Masukkan password">
                    </div>
                    <button class="btn btn-primary w-100 py-2 fw-bold" onclick="login()">
                        <i class="bi bi-box-arrow-in-right me-2"></i>MASUK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-primary fw-bold">
                        <i class="bi bi-person-plus-fill me-2"></i>Daftar Akun Baru
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formRegister">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" id="regUsername" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" id="regPassword" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Konfirmasi Password</label>
                            <input type="password" id="regPasswordConfirm" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Area Kerja</label>
                            <input type="text" id="regArea" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Unit</label>
                            <!-- select -->
                            <select id="regUnit" class="form-select" required>
                                <option value="">- Pilih Unit -</option>
                                <option value="Asam Sulfat">Asam Sulfat</option>
                                <option value="Asam Fosfat">Asam Fosfat</option>
                                <option value="Purifikasi">Purifikasi</option>
                                <option value="ALF3">ALF3</option>
                                <option value="UBB">UBB</option>
                            </select>
                        </div>

                        <button type="button" class="btn btn-primary w-100 py-2 fw-bold" onclick="registerUser()">
                            <i class="bi bi-check-circle me-2"></i>DAFTAR
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal fade" id="notificationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-primary fw-bold">
                        <i class="bi bi-bell-fill me-2"></i>Notifikasi Pekerjaan
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Pekerjaan hari ini yang belum lengkap:</p>
                    <ul id="notificationList" class="list-group"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Incomplete Job Modal -->
    <div class="modal fade" id="incompleteJobModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pekerjaan Belum Selesai</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Anda memiliki <strong id="incompleteCount">0</strong> pekerjaan yang belum selesai:</p>
                    <ul id="incompleteList"></ul>
                    <p class="text-muted">Apakah Anda ingin melanjutkan pekerjaan yang belum selesai?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Buat Baru</button>
                    <button type="button" class="btn btn-primary" onclick="resumeIncompleteJob()">Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ganti Jam Modal -->
    <div class="modal fade" id="gantiJamModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold"><i class="bi bi-clock-history"></i> Pengendalian SIMOPS - Ganti Jam
                        Kerja</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info py-2">
                        <i class="bi bi-info-circle"></i> Area Konflik: <strong id="gantiJamArea">-</strong>
                    </div>
                    <p class="text-muted small">Ubah jam kerja untuk menghindari konflik jadwal yang terjadi secara
                        bersamaan.</p>
                    <div id="gantiJamContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-warning fw-bold" onclick="submitGantiJam()">
                        <i class="bi bi-check-circle"></i> Simpan Perubahan Jam
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mitigasi Lainnya Modal -->
    <div class="modal fade" id="mitigasiLainnyaModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-people-fill"></i> Pengendalian SIMOPS - Mitigasi
                        Lainnya</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info py-2">
                        <i class="bi bi-info-circle"></i> Area Konflik: <strong id="mitigasiArea">-</strong>
                    </div>
                    <p class="text-muted small mb-3">Isi data personil yang akan mengawasi operasi simultan di area ini.
                    </p>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Nama Safety Officer (SO)</label>
                            <div id="soContainer">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control so-input" placeholder="Nama SO 1">
                                    <button type="button" class="btn btn-outline-success" onclick="addSOInput()">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Nama Safety Inspector (SI)</label>
                            <div id="siContainer">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control si-input" placeholder="Nama SI 1">
                                    <button type="button" class="btn btn-outline-success" onclick="addSIInput()">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Leader / Koordinator</label>
                            <input type="text" class="form-control" id="mitigasiLeader" placeholder="Nama Leader">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Jumlah Pekerja Total</label>
                            <input type="number" class="form-control" id="mitigasiJumlahPekerja"
                                placeholder="Jumlah pekerja" min="1">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Pekerjaan yang Terlibat:</label>
                        <ul id="mitigasiJobsList" class="list-group list-group-flush small"></ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-info text-white fw-bold" onclick="submitMitigasiLainnya()">
                        <i class="bi bi-check-circle"></i> Simpan Mitigasi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= APP SECTION ================= -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3 shadow-sm px-3 rounded-bottom app-navbar">
        <a class="navbar-brand fw-bold" href="#"><i class="bi bi-cone-striped"></i> Izin Kerja K3</a>
        <div class="ms-auto d-flex align-items-center gap-3">
            <span class="text-white small">Halo, <span id="navUser" class="fw-bold">Guest</span> (<span
                    id="navRole"></span>)<span id="notifBadge" class="badge bg-danger ms-2"
                    style="display:none; cursor:pointer;" onclick="showNotificationModal()"
                    onkeydown="if(event.key==='Enter'||event.key===' '){showNotificationModal();event.preventDefault();}"
                    role="button" aria-label="Notifikasi pekerjaan belum lengkap" tabindex="0"></span></span>
            <button class="btn btn-sm btn-outline-light" onclick="logout()">Keluar</button>
        </div>
    </nav>

    <div class="container app-container">

        <div id="page-dashboard" class="page">
            <h4 class="mb-4">Menu Utama</h4>
            <div class="row g-3" id="menuContainer"></div>
        </div>

        <div id="page-input" class="page">
            <h4><i class="bi bi-pencil-square"></i> Input Data Pekerjaan</h4>
            <hr>
            <form id="formJob">
                <div class="mb-2"><label class="fw-bold">Nama Perusahaan (PT)</label><input type="text" name="namaPT"
                        class="form-control" required></div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label>Kompartemen</label>
                        <select name="kompartemen" id="inKomp" class="form-select" onchange="setUnit()">
                            <option value="">- Pilih -</option>
                            <option value="Produksi 3A">Produksi 3A</option>
                            <option value="Produksi 3B">Produksi 3B</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label>Unit</label><select name="unit" id="inUnit" class="form-select" required>
                            <option value="">- Pilih Kompartemen Dulu -</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label>Jenis Pekerjaan</label>
                        <select name="jenisPekerjaan" class="form-select" required>
                            <option>Gabungan</option>
                            <option>Panas</option>
                            <option>Ketinggian</option>
                            <option>Penggalian</option>
                            <option>Lifting</option>
                            <option>Listrik</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-2"><label>Area Spesifik</label><input type="text" name="area"
                            class="form-control" required></div>
                </div>
                <div class="mb-2"><label>Nama Pekerjaan</label><input type="text" name="namaPekerjaan"
                        class="form-control" required></div>
                <div class="mb-2"><label>Penanggung Jawab (PJ)</label><input type="text" name="pjNama"
                        class="form-control" required></div>
                <div class="row">
                    <div class="col-md-4"><label>Tanggal</label><input type="date" name="tanggalKerja"
                            class="form-control" required></div>
                    <div class="col-md-4"><label>Jam Mulai</label><input type="time" name="jamMulai"
                            class="form-control" required></div>
                    <div class="col-md-4"><label>Jam Selesai</label><input type="time" name="jamSelesai"
                            class="form-control" required></div>
                </div>
                <br>
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" onclick="nav('page-dashboard')">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="submitJob()">Lanjut: Upload Dokumen <i
                            class="bi bi-arrow-right"></i></button>
                </div>
            </form>
        </div>

        <div id="page-upload" class="page">
            <h4><i class="bi bi-cloud-upload"></i> Upload Dokumen</h4>
            <div class="alert alert-info py-2">ID Pekerjaan: <strong id="lblJobId">...</strong></div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="chkLanjutan" onchange="toggleDocs()">
                <label class="form-check-label fw-bold" for="chkLanjutan">Pekerjaan Lanjutan (Hanya Wajib WP)</label>
            </div>

            <ul class="list-group mb-4">
                <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                    <div><strong>1. Work Permit (WP)</strong> <span class="badge bg-danger">Wajib</span></div>
                    <div><input type="file" id="f_WP" hidden
                            onchange="uploadFile('Work Permit','f_WP','btn_WP')"><button id="btn_WP"
                            class="btn btn-sm btn-outline-danger"
                            onclick="document.getElementById('f_WP').click()">Upload WP</button></div>
                </li>
                <div id="optDocs">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>2. JSA</div>
                        <div><input type="file" id="f_JSA" hidden onchange="uploadFile('JSA','f_JSA','btn_JSA')"><button
                                id="btn_JSA" class="btn btn-sm btn-outline-primary"
                                onclick="document.getElementById('f_JSA').click()">Upload</button></div>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>3. PJA</div>
                        <div><input type="file" id="f_PJA" hidden onchange="uploadFile('PJA','f_PJA','btn_PJA')"><button
                                id="btn_PJA" class="btn btn-sm btn-outline-primary"
                                onclick="document.getElementById('f_PJA').click()">Upload</button></div>
                    </li>
                </div>
            </ul>
            <button id="btnToRisk" class="btn btn-success w-100" onclick="nav('page-risk-input')">Lanjut: Penilaian
                Risiko <i class="bi bi-arrow-right"></i></button>
            <button id="btnBackToAdmin" class="btn btn-secondary w-100 mt-2" style="display:none"
                onclick="nav('page-list-admin')">Kembali ke List</button>
        </div>

        <div id="page-risk-input" class="page">
            <h4><i class="bi bi-shield-exclamation"></i> Penilaian Risiko (Risk Assessment)</h4>
            <div class="alert alert-warning small">
                Gunakan skala 1-5 untuk Kemungkinan & Dampak. Sistem menghitung Tingkat Risiko otomatis.
            </div>

            <div id="riskContainer"></div>

            <button class="btn btn-outline-primary w-100 mb-4 border-dashed" onclick="addActivityBlock()">
                <i class="bi bi-plus-circle"></i> Tambah Aktivitas Baru
            </button>

            <button class="btn btn-warning w-100 fw-bold py-2" onclick="submitRisk()">SIMPAN PENILAIAN SELESAI</button>
            <button class="btn btn-light w-100 mt-2" onclick="nav('page-dashboard')">Batal</button>
        </div>

        <div id="page-rekap" class="page">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4><i class="bi bi-list-check"></i> Monitoring & SIMOPS</h4>
                    <div id="rekapUnitInfo" class="small text-muted" style="display:none;"></div>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="nav('page-dashboard')">Kembali</button>
            </div>
            <div id="simopsContainer"></div>
            <div id="rekapContainer" class="row g-3">Loading...</div>
        </div>

        <div id="page-list-admin" class="page">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="bi bi-folder2-open"></i> Data Pekerjaan</h4>
                <button class="btn btn-secondary btn-sm" onclick="nav('page-dashboard')">Kembali</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-bordered bg-white">
                    <thead class="table-dark">
                        <tr>
                            <th>Tanggal</th>
                            <th>PT / Pekerjaan</th>
                            <th>Status Doc</th>
                            <th>Status Risk</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="adminListBody"></tbody>
                </table>
            </div>
        </div>

        <div id="page-user" class="page">
            <h4>Tambah User Baru</h4>
            <form id="formUser">
                <div class="mb-2"><label>Username</label><input type="text" name="regUser" class="form-control"></div>
                <div class="mb-2"><label>Password</label><input type="text" name="regPass" class="form-control"></div>
                <div class="mb-2"><label>Role</label>
                    <select name="regRole" class="form-select">
                        <option value="Staff">Pekerja (Staff)</option>
                        <option value="Admin">Safety/Admin</option>
                        <option value="Inspector">Inspector</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary mt-2" onclick="submitUser()">Buat Akun</button>
                <button type="button" class="btn btn-light mt-2" onclick="nav('page-dashboard')">Kembali</button>
            </form>
        </div>

        <div id="page-user-approval" class="page">
            <h4><i class="bi bi-person-check"></i> Persetujuan Registrasi User</h4>
            <hr>
            <div class="table-responsive">
                <table class="table table-hover table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Username</th>
                            <th>Area</th>
                            <th>Unit</th>
                            <th>Tanggal Registrasi</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="approvalListBody"></tbody>
                </table>
            </div>
            <button type="button" class="btn btn-light mt-2" onclick="nav('page-dashboard')">Kembali</button>
        </div>

        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Detail Pekerjaan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="modalContent"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="residualRiskModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-shield-check"></i> Penilaian Risiko Residual</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="alert alert-light border">
                        <strong>ID SIMOPS:</strong> <span id="resSimopsId" class="text-primary fw-bold"></span>
                    </div>
                    <p class="small text-muted">Masukkan nilai risiko setelah pengendalian (mitigasi) dilakukan.</p>

                    <div class="row g-3 justify-content-center align-items-center mt-2">
                        <div class="col-4">
                            <label class="fw-bold text-success">Max L</label>
                            <input type="number" id="resL" class="form-control text-center fw-bold fs-5" min="1" max="5"
                                value="1" onchange="calcResRR()">
                            <small class="text-muted" style="font-size:10px">(Likelihood)</small>
                        </div>
                        <div class="col-1 text-center pt-4 fw-bold">X</div>
                        <div class="col-4">
                            <label class="fw-bold text-success">Max C</label>
                            <input type="number" id="resC" class="form-control text-center fw-bold fs-5" min="1" max="5"
                                value="1" onchange="calcResRR()">
                            <small class="text-muted" style="font-size:10px">(Consequence)</small>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="text-muted mb-0">Risk Rating (RR)</h6>
                        <h1 id="resRR" class="display-4 fw-bold text-success mb-0">1</h1>
                        <span id="resCat" class="badge bg-success">Low</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success w-100 fw-bold py-2" onclick="submitResidualRisk()">
                        <i class="bi bi-save"></i> SIMPAN & SELESAI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==========================================================
        // KONFIGURASI BACKEND (GANTI DENGAN URL RENDER ANDA)
        // ==========================================================
        const API_BASE_URL = "https://simops-backend.onrender.com";
        // ==========================================================

        let currUser = { name: '', role: '' };
        let currJobId = '';
        let allJobsCache = [];
        let loginModal;
        let simopsHistoryCache = [];

        const units = {
            "Produksi 3A": ["Asam Sulfat", "Asam Fosfat", "ZAII", "Purifikasi", "ET"],
            "Produksi 3B": ["Asam Sulfat", "Asam Fosfat", "Purifikasi", "ALF3", "UBB"]
        };

        const optProb = [{ v: 1, t: "1 - Sangat Jarang" }, { v: 2, t: "2 - Jarang" }, { v: 3, t: "3 - Mungkin" }, { v: 4, t: "4 - Mungkin Sekali" }, { v: 5, t: "5 - Hampir Pasti" }];
        const optImp = [{ v: 1, t: "1 - Tidak Signifikan" }, { v: 2, t: "2 - Kecil" }, { v: 3, t: "3 - Sedang" }, { v: 4, t: "4 - Besar" }, { v: 5, t: "5 - Bencana" }];

        // --- UTILS ---
        const showLoading = () => document.getElementById('loadingOverlay').style.display = 'flex';
        const hideLoading = () => document.getElementById('loadingOverlay').style.display = 'none';

        function generateSimopsId() {
            const date = new Date();
            const ymd = date.toISOString().slice(0, 10).replace(/-/g, ""); // 20230101
            const rand = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `SIM-${ymd}-${rand}`;
        }
        // --- SCROLL ANIMATION OBSERVER ---
        function initScrollAnimations() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animated');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            // Observe elements with animate-on-scroll class
            document.querySelectorAll('.animate-on-scroll').forEach(el => {
                observer.observe(el);
            });

            // Also animate feature cards when they come into view
            document.querySelectorAll('.feature-card').forEach((card, index) => {
                card.style.animationDelay = `${0.2 + (index * 0.2)}s`;
            });
        }

        // --- RESIDUAL RISK LOGIC ---

        let currentResidualId = '';

        function openResidualModal(simopsId) {
            currentResidualId = simopsId;
            document.getElementById('resSimopsId').innerText = simopsId;

            // Reset values
            document.getElementById('resL').value = 1;
            document.getElementById('resC').value = 1;
            calcResRR();

            // Show Modal
            new bootstrap.Modal(document.getElementById('residualRiskModal')).show();
        }

        function calcResRR() {
            const l = parseInt(document.getElementById('resL').value) || 1;
            const c = parseInt(document.getElementById('resC').value) || 1;
            const rr = l * c;

            const rrEl = document.getElementById('resRR');
            const catEl = document.getElementById('resCat');

            rrEl.innerText = rr;

            if (rr <= 4) {
                rrEl.className = "display-4 fw-bold text-success mb-0";
                catEl.className = "badge bg-success"; catEl.innerText = "Low";
            } else if (rr <= 9) {
                rrEl.className = "display-4 fw-bold text-warning mb-0";
                catEl.className = "badge bg-warning text-dark"; catEl.innerText = "Medium";
            } else {
                rrEl.className = "display-4 fw-bold text-danger mb-0";
                catEl.className = "badge bg-danger"; catEl.innerText = "High";
            }
        }

        async function submitResidualRisk() {
            const l = document.getElementById('resL').value;
            const c = document.getElementById('resC').value;
            const rr = document.getElementById('resRR').innerText;

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/simops/residual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        simopsId: currentResidualId,
                        l: l,
                        c: c,
                        rr: rr
                    })
                });

                if (res.ok) {
                    alert("Penilaian Risiko Residual Berhasil Disimpan!");
                    bootstrap.Modal.getInstance(document.getElementById('residualRiskModal')).hide();
                    loadRekap(); // Refresh tampilan dashboard
                } else {
                    alert("Gagal menyimpan risiko residual.");
                }
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                hideLoading();
            }
        }

        // Initialize scroll animations on page load
        document.addEventListener('DOMContentLoaded', function () {
            initScrollAnimations();

            // Re-trigger hero animations when returning to landing page
            const heroElements = document.querySelectorAll('.hero-title, .hero-subtitle, .hero-image img');
            heroElements.forEach(el => {
                el.style.animationPlayState = 'running';
            });
        });

        // --- FUNGSI TAMBAHAN UNTUK RESET UI ---
        function resetUploadUI() {
            // 1. Reset Tombol Work Permit (WP)
            const btnWP = document.getElementById('btn_WP');
            btnWP.innerText = 'Upload WP';
            btnWP.disabled = false;
            btnWP.className = 'btn btn-sm btn-outline-danger'; // Kelas awal
            document.getElementById('f_WP').value = ''; // Kosongkan input file

            // 2. Reset Tombol JSA
            const btnJSA = document.getElementById('btn_JSA');
            btnJSA.innerText = 'Upload';
            btnJSA.disabled = false;
            btnJSA.className = 'btn btn-sm btn-outline-primary'; // Kelas awal
            document.getElementById('f_JSA').value = '';

            // 3. Reset Tombol PJA
            const btnPJA = document.getElementById('btn_PJA');
            btnPJA.innerText = 'Upload';
            btnPJA.disabled = false;
            btnPJA.className = 'btn btn-sm btn-outline-primary'; // Kelas awal
            document.getElementById('f_PJA').value = '';

            // 4. Reset Checkbox Pekerjaan Lanjutan
            const chk = document.getElementById('chkLanjutan');
            chk.checked = false;
            toggleDocs(); // Panggil fungsi ini agar elemen JSA/PJA muncul kembali (default)

            // 5. (Opsional) Reset Container Risiko juga agar bersih jika user back
            document.getElementById('riskContainer').innerHTML = '';
        }

        // Initialize modal on page load
        document.addEventListener('DOMContentLoaded', function () {
            loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        });

        function showLoginModal() {
            loginModal.show();
        }

        function nav(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            if (page === 'page-rekap') loadRekap();
            if (page === 'page-list-admin') loadAdminList();
            if (page === 'page-user-approval') loadPendingUsers();
        }

        // --- AUTHENTICATION ---
        async function login() {
            const u = document.getElementById('u').value;
            const p = document.getElementById('p').value;

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();

                if (res.ok && data.status === 'Sukses') {
                    // Check account status
                    if (data.statusAkun === 'Pending') {
                        alert('Akun Anda menunggu persetujuan admin');
                        hideLoading();
                        return;
                    }
                    if (data.statusAkun === 'Rejected') {
                        alert('Akun Anda ditolak oleh admin');
                        hideLoading();
                        return;
                    }

                    currUser = { name: u, role: data.role, area: data.area || '', unit: data.unit || '' };
                    document.getElementById('navUser').innerText = u;
                    document.getElementById('navRole').innerText = data.role;

                    // Hide login modal if open
                    if (loginModal) loginModal.hide();

                    // Switch to app view
                    document.body.classList.add('logged-in');

                    setupMenu();
                    nav('page-dashboard');

                    // Check for incomplete jobs
                    await checkIncompleteJobs();

                    // Fetch notifications for Staff
                    if (data.role === 'Staff') {
                        await fetchNotifications();
                    }
                } else {
                    alert('Login Gagal: ' + (data.message || 'Error'));
                }
            } catch (err) {
                alert('Gagal koneksi ke server: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        function logout() {
            currUser = {};
            document.getElementById('u').value = '';
            document.getElementById('p').value = '';

            // Switch back to landing page
            document.body.classList.remove('logged-in');

            // Hide all app pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        }

        function setupMenu() {
            const c = document.getElementById('menuContainer');
            let html = '';
            if (currUser.role === 'Staff') {
                html += `<div class="col-md-4"><div class="card menu-card p-4 text-center" onclick="nav('page-input')"><i class="bi bi-pencil-square fs-1 text-primary"></i><h5 class="mt-2">Input Pekerjaan</h5></div></div>`;
            }
            if (currUser.role === 'Admin' || currUser.role === 'Inspector') {
                html += `<div class="col-md-4"><div class="card menu-card p-4 text-center" onclick="nav('page-list-admin')"><i class="bi bi-folder2-open fs-1 text-primary"></i><h5 class="mt-2">Data Pekerjaan & Dokumen</h5></div></div>`;
            }
            html += `<div class="col-md-4"><div class="card menu-card p-4 text-center" onclick="nav('page-rekap')"><i class="bi bi-table fs-1 text-success"></i><h5 class="mt-2">Rekap & SIMOPS</h5></div></div>`;
            if (currUser.role === 'Admin') {
                html += `<div class="col-md-4"><div class="card menu-card p-4 text-center" onclick="nav('page-user')"><i class="bi bi-person-plus fs-1 text-warning"></i><h5 class="mt-2">Tambah User</h5></div></div>`;
                html += `<div class="col-md-4"><div class="card menu-card p-4 text-center" onclick="nav('page-user-approval')"><i class="bi bi-person-check fs-1 text-info"></i><h5 class="mt-2">Persetujuan User</h5></div></div>`;
            }
            c.innerHTML = html;
        }

        function setUnit() {
            const k = document.getElementById('inKomp').value;
            const u = document.getElementById('inUnit');
            u.innerHTML = '<option value="">- Pilih -</option>';
            if (units[k]) units[k].forEach(x => { u.innerHTML += `<option>${x}</option>`; });
        }

        // --- SUBMIT JOB ---
        async function submitJob() {
            const form = document.getElementById('formJob');
            if (!form.reportValidity()) return;

            const formData = new FormData(form);
            const jsonData = Object.fromEntries(formData.entries());

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/jobs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonData)
                });
                const data = await res.json();

                if (res.ok) {
                    currJobId = data.id;
                    document.getElementById('lblJobId').innerText = data.id;
                    form.reset();
                    resetUploadUI();
                    document.getElementById('btnToRisk').style.display = 'block';
                    document.getElementById('btnBackToAdmin').style.display = 'none';
                    nav('page-upload');
                } else {
                    alert('Gagal simpan data: ' + data.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        function toggleDocs() {
            const chk = document.getElementById('chkLanjutan');
            document.getElementById('optDocs').style.display = chk.checked ? 'none' : 'block';
        }

        // --- UPLOAD FILE ---
        async function uploadFile(jenis, inpId, btnId) {
            const f = document.getElementById(inpId).files[0];
            if (!f) return;

            const btn = document.getElementById(btnId);
            btn.innerText = 'Uploading...'; btn.disabled = true;

            const formData = new FormData();
            formData.append('file', f);
            formData.append('idPekerjaan', currJobId);
            formData.append('jenisDokumen', jenis);

            try {
                const res = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (res.ok) {
                    alert('Upload Berhasil!');
                    btn.className = 'btn btn-sm btn-success'; btn.innerText = 'OK';
                } else {
                    alert('Gagal: ' + data.error);
                    btn.innerText = 'Coba Lagi'; btn.disabled = false;
                }
            } catch (err) {
                alert('Error: ' + err.message);
                btn.innerText = 'Error'; btn.disabled = false;
            }
        }

        // --- RISK ASSESMENT UI ---
        function addActivityBlock() {
            const div = document.createElement('div');
            div.className = 'activity-group bg-white';
            div.innerHTML = `
            <div class="activity-header">
                <input type="text" class="form-control form-control-sm me-2 act-name" placeholder="Nama Aktivitas" style="max-width:300px">
                <button class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()"><i class="bi bi-trash"></i></button>
            </div>
            <div class="p-2">
                <table class="table table-sm table-bordered mb-2">
                    <thead class="table-light"><tr><th>Bahaya</th><th width="120">Kemungkinan</th><th width="120">Dampak</th><th width="80">Risiko</th><th width="30"></th></tr></thead>
                    <tbody class="hazard-body"></tbody>
                </table>
                <button class="btn btn-sm btn-outline-success" onclick="addHazardRow(this)"><i class="bi bi-plus"></i> Tambah Bahaya</button>
            </div>`;
            document.getElementById('riskContainer').appendChild(div);
            addHazardRow(div.querySelector('.btn-outline-success'));
        }

        function addHazardRow(btn) {
            const tbody = btn.previousElementSibling.querySelector('tbody');
            const tr = document.createElement('tr');
            let optP = optProb.map(o => `<option value="${o.v} - ${o.t}">${o.t}</option>`).join('');
            let optI = optImp.map(o => `<option value="${o.v} - ${o.t}">${o.t}</option>`).join('');

            tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm haz"></td>
            <td><select class="form-select form-select-sm l" onchange="calcRR(this)">${optP}</select></td>
            <td><select class="form-select form-select-sm c" onchange="calcRR(this)">${optI}</select></td>
            <td><input type="text" class="form-control form-control-sm rr fw-bold text-center" readonly value="1"></td>
            <td><i class="bi bi-x text-danger" style="cursor:pointer" onclick="this.closest('tr').remove()"></i></td>`;
            tbody.appendChild(tr);
        }

        function calcRR(el) {
            const row = el.closest('tr');
            const l = parseInt(row.querySelector('.l').value);
            const c = parseInt(row.querySelector('.c').value);
            row.querySelector('.rr').value = l * c;
        }

        async function submitRisk() {
            let dataRisiko = [];
            document.querySelectorAll('.activity-group').forEach(group => {
                let actName = group.querySelector('.act-name').value;
                group.querySelectorAll('tbody tr').forEach(tr => {
                    dataRisiko.push({
                        aktivitas: actName,
                        bahaya: tr.querySelector('.haz').value,
                        l: tr.querySelector('.l').value,
                        c: tr.querySelector('.c').value,
                        rr: tr.querySelector('.rr').value
                    });
                });
            });

            if (dataRisiko.length === 0) return alert("Isi minimal satu aktivitas!");

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/risks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idPekerjaan: currJobId, dataRisiko })
                });
                if (res.ok) {
                    alert('Data Berhasil Disimpan!');
                    document.getElementById('riskContainer').innerHTML = '';
                    // Refresh notifications for Staff after completing work
                    if (currUser.role === 'Staff') {
                        await fetchNotifications();
                    }
                    nav('page-dashboard');
                } else {
                    alert('Gagal simpan risiko');
                }
            } catch (err) { alert(err.message); }
            finally { hideLoading(); }
        }

        // --- ADMIN FEATURES ---
        async function submitUser() {
            const form = document.getElementById('formUser');
            const formData = new FormData(form);
            const jsonData = Object.fromEntries(formData.entries());

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/register`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(jsonData)
                });
                const data = await res.json();
                alert(data.message);
                if (res.ok) form.reset();
            } catch (e) { alert(e.message); }
            finally { hideLoading(); }
        }

        async function loadAdminList() {
            document.getElementById('adminListBody').innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';
            try {
                // Kirim role ke backend
                const res = await fetch(`${API_BASE_URL}/api/rekap?role=${encodeURIComponent(currUser.role)}`);
                const jobs = await res.json();
                renderAdminList(jobs);
            } catch (e) {
                document.getElementById('adminListBody').innerHTML = '<tr><td colspan="5" class="text-danger">Gagal load data</td></tr>';
            }
        }

        function renderAdminList(jobs) {
            allJobsCache = jobs || [];
            const tbody = document.getElementById('adminListBody');
            tbody.innerHTML = '';

            if (jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Belum ada data.</td></tr>';
                return;
            }

            jobs.forEach(j => {
                let btnAction = `<button class="btn btn-sm btn-info text-white" onclick="showDetail('${j.id}')">Detail & Docs</button>`;
                tbody.innerHTML += `<tr>
                <td>${j.tanggal}<br><small>${j.jamMulai}-${j.jamSelesai}</small></td>
                <td><strong>${j.namaPT}</strong><br>${j.pekerjaan}</td>
                <td>${j.statusDoc}</td>
                <td>${j.statusRisk}</td>
                <td>${btnAction}</td>
             </tr>`;
            });
        }

        function showDetail(id) {
            const j = allJobsCache.find(x => x.id === id);
            if (!j) return;
            currJobId = id;

            let docsHtml = '<ul class="list-group mb-3">';
            if (j.docs.length > 0) {
                j.docs.forEach(d => {
                    docsHtml += `<li class="list-group-item d-flex justify-content-between"><span>${d.jenis}</span><a href="${d.url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i> Lihat</a></li>`;
                });
            } else { docsHtml += '<li class="list-group-item text-muted">Belum ada dokumen</li>'; }
            docsHtml += '</ul>';

            docsHtml += `<button class="btn btn-sm btn-secondary mb-3" onclick="document.getElementById('lblJobId').innerText='${id}'; document.getElementById('btnToRisk').style.display='none'; document.getElementById('btnBackToAdmin').style.display='block'; nav('page-upload'); bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide(); ">+ Upload Dokumen Tambahan</button>`;

            let approveBtn = '';
            if (currUser.role === 'Inspector' && j.statusDoc !== 'APPROVED') {
                approveBtn = `<button class="btn btn-success w-100 mb-3" onclick="doApprove('${id}')"><i class="bi bi-check-circle"></i> APPROVE DOKUMEN</button>`;
            }

            let riskHtml = '<table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Akt</th><th>Bahaya</th><th>L</th><th>C</th><th>RR</th></tr></thead><tbody>';
            if (j.riskData && j.riskData.details) {
                j.riskData.details.forEach(r => {
                    riskHtml += `<tr><td>${r.act}</td><td>${r.hazard}</td><td>${r.l}</td><td>${r.c}</td><td class="fw-bold">${r.rr}</td></tr>`;
                });
            }
            riskHtml += '</tbody></table>';

            const content = `<h6>Informasi Pekerjaan</h6><p><strong>${j.namaPT}</strong> - ${j.pekerjaan} (${j.area})</p><hr><h6>Dokumen</h6>${docsHtml}${approveBtn}<hr><h6>Penilaian Risiko</h6>${riskHtml}`;
            document.getElementById('modalContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        async function doApprove(id) {
            if (!confirm('Setujui dokumen pekerjaan ini?')) return;
            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/jobs/${id}/approve`, { method: 'PUT' });
                const data = await res.json();
                alert(data.message);
                loadAdminList();
                bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
            } catch (e) { alert(e.message); }
            finally { hideLoading(); }
        }

        // --- REKAP & SIMOPS (Load Data) ---
        async function loadRekap() {
            document.getElementById('rekapContainer').innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary"></div><p>Sedang memuat data...</p></div>';

            try {
                // 1. Fetch Data Pekerjaan (Untuk deteksi konflik)
                let urlJobs = `${API_BASE_URL}/api/rekap`;
                if (currUser.role === 'Staff' && currUser.unit) {
                    urlJobs += `?unit=${encodeURIComponent(currUser.unit)}`;
                }

                // 2. Fetch Data History SIMOPS (Untuk cek yang sudah disave)
                let urlSimops = `${API_BASE_URL}/api/simops/rekap`;

                const [resJobs, resSimops] = await Promise.all([
                    fetch(urlJobs),
                    fetch(urlSimops)
                ]);

                const jobs = await resJobs.json();
                const simopsData = await resSimops.json();

                simopsHistoryCache = simopsData.data || []; // Simpan ke cache

                renderRekap(jobs);
            } catch (err) {
                document.getElementById('rekapContainer').innerHTML = `<div class="alert alert-danger">Gagal mengambil data: ${err.message}</div>`;
            }
        }

        function isOverlap(t1S, t1E, t2S, t2E) {
            if (!t1S || !t1E || !t2S || !t2E) return false;
            try {
                const toM = t => parseInt(t.split(':')[0]) * 60 + parseInt(t.split(':')[1]);
                let s1 = toM(t1S), e1 = toM(t1E);
                let s2 = toM(t2S), e2 = toM(t2E);
                if (e1 < s1) e1 += 24 * 60;
                if (e2 < s2) e2 += 24 * 60;
                return (s1 < e2 && e1 > s2);
            } catch (e) { return false; }
        }

        function renderRekap(jobs) {
            // 1. Validasi Data Kosong
            if (!jobs || !Array.isArray(jobs) || jobs.length === 0) {
                document.getElementById('rekapContainer').innerHTML = '<div class="alert alert-info">Belum ada data pekerjaan yang tercatat.</div>';
                document.getElementById('simopsContainer').innerHTML = '';
                return;
            }

            // 2. Grouping Pekerjaan per Area
            let areas = {};
            jobs.forEach(j => {
                let areaName = j.area || "Area Umum";
                if (!areas[areaName]) areas[areaName] = [];
                areas[areaName].push(j);
            });

            let html = '';
            let simopsHtml = '';

            // 3. Loop per Area untuk Cek Konflik & Render Card
            for (const [area, areaJobs] of Object.entries(areas)) {
                let conflict = false;
                let conflictJobs = [];

                // Logika Deteksi Overlap (Bubble Check)
                for (let i = 0; i < areaJobs.length; i++) {
                    for (let j = i + 1; j < areaJobs.length; j++) {
                        if (isOverlap(areaJobs[i].jamMulai, areaJobs[i].jamSelesai, areaJobs[j].jamMulai, areaJobs[j].jamSelesai)) {
                            conflict = true;
                            if (!conflictJobs.includes(areaJobs[i])) conflictJobs.push(areaJobs[i]);
                            if (!conflictJobs.includes(areaJobs[j])) conflictJobs.push(areaJobs[j]);
                        }
                    }
                }

                // Render Header Area
                html += `<div class="col-12 mt-3"><h5 class="border-bottom pb-2 text-primary">${area}</h5></div>`;

                // Render Card Pekerjaan
                areaJobs.forEach(job => {
                    let isConflict = conflictJobs.includes(job);
                    let borderClass = isConflict ? 'border-danger border-2' : 'border-light shadow-sm';
                    let unitBadge = job.unit ? `<span class="badge bg-info text-white me-1"><i class="bi bi-geo"></i> ${job.unit}</span>` : '';

                    html += `<div class="col-md-4 mb-3"><div class="card h-100 ${borderClass}"><div class="card-body">
                  <h6 class="fw-bold">${job.jenis} - ${job.pekerjaan}</h6>
                  <div class="mb-1 text-primary fw-bold small"><i class="bi bi-building"></i> ${job.namaPT}</div>
                  <div class="mb-2">${unitBadge}<small class="badge bg-secondary"><i class="bi bi-clock"></i> ${job.jamMulai} - ${job.jamSelesai}</small></div>
                  <div class="small border-top pt-2">
                    <span class="d-block"><strong>Dokumen:</strong> ${job.statusDoc}</span>
                    <span class="d-block"><strong>Risiko:</strong> L=${job.riskData.maxL}, C=${job.riskData.maxC}</span>
                  </div></div></div></div>`;
                });

                // 4. Logika Tampilan SIMOPS (Conflict Handling)
                if (conflict) {
                    // Hitung Risiko Gabungan (Maksimal)
                    let maxL = 0, maxC = 0;
                    conflictJobs.forEach(j => {
                        if (j.riskData.maxL > maxL) maxL = j.riskData.maxL;
                        if (j.riskData.maxC > maxC) maxC = j.riskData.maxC;
                    });
                    let combinedRR = maxL * maxC;

                    // --- [UPDATE] CEK HISTORY DATABASE (CACHE) ---
                    // Cek apakah ada data SIMOPS tersimpan yang cocok dengan Area & Tanggal pekerjaan ini
                    const jobDate = areaJobs[0].tanggal;
                    // Pastikan simopsHistoryCache sudah terisi via loadRekap()
                    const savedSimops = (window.simopsHistoryCache || []).find(s => s.area === area && s.tanggal === jobDate);

                    if (savedSimops) {
                        // === KONDISI A: SUDAH DISIMPAN/DIMITIGASI (TAMPILAN HIJAU) ===

                        let residualBlock = '';
                        // Cek apakah Risiko Residual sudah diisi di data savedSimops
                        if (savedSimops.dataResidual && savedSimops.dataResidual.rr) {
                            // Tampilkan Nilai Risiko Residual
                            residualBlock = `
                            <div class="mt-2 p-2 border rounded bg-white text-center">
                                <small class="fw-bold text-success d-block mb-1">RISIKO RESIDUAL (SISA)</small>
                                <div class="d-flex justify-content-center align-items-center gap-2 fw-bold">
                                    <span class="badge bg-light text-dark border">Max L: ${savedSimops.dataResidual.maxL}</span>
                                    <span class="text-muted">x</span>
                                    <span class="badge bg-light text-dark border">Max C: ${savedSimops.dataResidual.maxC}</span>
                                    <span class="text-muted">=</span>
                                    <span class="badge bg-success fs-6">RR: ${savedSimops.dataResidual.rr}</span>
                                </div>
                            </div>`;
                        } else {
                            // Tampilkan Tombol Input Residual
                            residualBlock = `
                            <div class="mt-2 text-center">
                                <button class="btn btn-sm btn-outline-success fw-bold shadow-sm" onclick="openResidualModal('${savedSimops.idSimops}')">
                                    <i class="bi bi-pencil-square"></i> Input Risiko Residual
                                </button>
                            </div>`;
                        }

                        simopsHtml += `
                        <div class="alert alert-success border-success border-2 mb-3 shadow-sm">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="fw-bold mb-0 text-success"><i class="bi bi-check-circle-fill"></i> SIMOPS Terkendali</h5>
                                    <small class="text-muted">Konflik di ${area} telah dimitigasi</small>
                                </div>
                                <span class="badge bg-dark font-monospace">${savedSimops.idSimops}</span>
                            </div>
                            
                            <div class="p-2 bg-light rounded border mb-2 small">
                                <strong>Mitigasi:</strong> ${savedSimops.keputusan || savedSimops.keputusanPengendalian}
                            </div>
                            
                            ${residualBlock}
                        </div>`;

                    } else {
                        // === KONDISI B: BELUM DISIMPAN (TAMPILAN MERAH + TOMBOL AKSI) ===

                        let controlButtons = '';
                        if (currUser.role === 'Admin') {
                            const conflictJobsJson = encodeURIComponent(JSON.stringify(conflictJobs));
                            controlButtons = `
                            <div class="mt-3 pt-3 border-top">
                                <h6 class="fw-bold text-dark"><i class="bi bi-shield-check"></i> Pengendalian Risiko SIMOPS</h6>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="btn btn-warning btn-sm fw-bold" onclick="showGantiJamModal('${area}', '${conflictJobsJson}')">
                                        <i class="bi bi-clock-history"></i> Ganti Jam Kerja
                                    </button>
                                    <button class="btn btn-info btn-sm text-white fw-bold" onclick="showMitigasiLainnyaModal('${area}', '${conflictJobsJson}')">
                                        <i class="bi bi-people-fill"></i> Mitigasi Lainnya
                                    </button>
                                </div>
                            </div>`;
                        }

                        simopsHtml += `
                        <div class="alert alert-danger border-danger border-3 mb-3 shadow-sm">
                           <h5 class="fw-bold text-danger"><i class="bi bi-exclamation-triangle-fill"></i> SIMOPS Terdeteksi: ${area}</h5>
                           <p class="mb-2">Konflik jadwal antara:</p>
                           <ul class="mb-2 small bg-white rounded p-2 border">
                                ${conflictJobs.map(j => `<li><strong>${j.namaPT}</strong>: ${j.pekerjaan} (${j.jamMulai}-${j.jamSelesai})</li>`).join('')}
                           </ul>
                           <div class="d-flex align-items-center gap-2 bg-white p-2 rounded border">
                              <small class="fw-bold text-muted">RISIKO GABUNGAN:</small>
                              <span class="badge bg-light text-dark border">Max L: ${maxL}</span>
                              <span class="text-muted">x</span>
                              <span class="badge bg-light text-dark border">Max C: ${maxC}</span>
                              <span class="text-muted">=</span>
                              <span class="badge bg-danger fs-6">RR: ${combinedRR}</span>
                           </div>
                           ${controlButtons}
                        </div>`;
                    }
                }
            }

            // 5. Update DOM
            document.getElementById('rekapContainer').innerHTML = html;
            document.getElementById('simopsContainer').innerHTML = simopsHtml || '<div class="alert alert-success border-success shadow-sm"><i class="bi bi-check-circle-fill"></i> Tidak ada konflik SIMOPS terdeteksi hari ini.</div>';
        }

        // --- FEATURE 1: NOTIFICATION FUNCTIONS ---
        let notificationsData = [];

        async function fetchNotifications() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/notifications`);
                if (res.ok) {
                    notificationsData = await res.json();
                    updateNotificationBadge();
                }
            } catch (err) {
                console.error('Failed to fetch notifications:', err);
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notifBadge');
            if (notificationsData && notificationsData.length > 0) {
                badge.innerText = notificationsData.length;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        function showNotificationModal() {
            const list = document.getElementById('notificationList');
            list.innerHTML = '';

            if (notificationsData.length === 0) {
                list.innerHTML = '<li class="list-group-item text-muted">Tidak ada notifikasi</li>';
            } else {
                notificationsData.forEach(notif => {
                    list.innerHTML += `
                        <li class="list-group-item">
                            <strong>${notif.pekerjaan}</strong><br>
                            <small class="text-muted">${notif.namaPT} - ${notif.area}</small><br>
                            <small class="text-danger">Status: ${notif.statusDoc || 'Belum upload dokumen'}</small>
                        </li>
                    `;
                });
            }

            new bootstrap.Modal(document.getElementById('notificationModal')).show();
        }

        // --- FEATURE 3: INCOMPLETE JOBS FUNCTIONS ---
        let incompleteJobsData = [];

        async function checkIncompleteJobs() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/jobs/incomplete?username=${currUser.name}`);
                if (res.ok) {
                    incompleteJobsData = await res.json();
                    if (incompleteJobsData && incompleteJobsData.length > 0) {
                        showIncompleteJobModal();
                    }
                }
            } catch (err) {
                console.error('Failed to check incomplete jobs:', err);
            }
        }

        function showIncompleteJobModal() {
            document.getElementById('incompleteCount').innerText = incompleteJobsData.length;
            const list = document.getElementById('incompleteList');
            list.innerHTML = '';

            incompleteJobsData.forEach(job => {
                const status = job.statusDoc === 'Lengkap' ? 'Belum isi risiko' : 'Belum upload dokumen';
                list.innerHTML += `
                    <li>
                        <strong>${job.pekerjaan}</strong> - ${job.namaPT}<br>
                        <small class="text-muted">Status: ${status}</small>
                    </li>
                `;
            });

            new bootstrap.Modal(document.getElementById('incompleteJobModal')).show();
        }

        function resumeIncompleteJob() {
            if (incompleteJobsData.length > 0) {
                const job = incompleteJobsData[0]; // Resume first incomplete job
                currJobId = job._id || job.id;

                // Hide modal
                bootstrap.Modal.getInstance(document.getElementById('incompleteJobModal')).hide();

                // Navigate based on status
                if (job.statusDoc === 'Lengkap') {
                    // Documents uploaded, need to fill risk assessment
                    nav('page-risk-input');
                } else {
                    // Need to upload documents
                    document.getElementById('lblJobId').innerText = currJobId;
                    nav('page-upload');
                }
            }
        }

        // --- FEATURE 4: REGISTRATION FUNCTIONS ---
        function showRegisterModal() {
            new bootstrap.Modal(document.getElementById('registerModal')).show();
        }

        async function registerUser() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const area = document.getElementById('regArea').value;
            const unit = document.getElementById('regUnit').value;

            if (!username.trim() || !password.trim() || !passwordConfirm.trim() || !area.trim() || !unit.trim()) {
                alert('Semua field harus diisi!');
                return;
            }

            if (password !== passwordConfirm) {
                alert('Password dan konfirmasi password tidak cocok!');
                return;
            }

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        regUser: username,
                        regPass: password,
                        regRole: 'Staff',
                        area: area,
                        unit: unit
                    })
                });
                const data = await res.json();

                if (res.ok) {
                    alert('Registrasi berhasil! Menunggu persetujuan admin.');
                    bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
                    document.getElementById('formRegister').reset();
                } else {
                    alert('Registrasi gagal: ' + (data.message || 'Error'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        // --- FEATURE 4: USER APPROVAL FUNCTIONS ---
        async function loadPendingUsers() {
            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/users/pending`);
                const data = await res.json();
                // Handle berbagai format response dari backend
                const users = Array.isArray(data) ? data : (data.users || data.data || []);
                renderPendingUsers(users);
            } catch (err) {
                alert('Gagal load data: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        function renderPendingUsers(users) {
            const tbody = document.getElementById('approvalListBody');
            tbody.innerHTML = '';

            if (!Array.isArray(users) || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Tidak ada registrasi pending</td></tr>';
                return;
            }

            users.forEach(user => {
                const tanggal = user.tanggalRegistrasi || user.createdAt || '-';
                tbody.innerHTML += `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.area || '-'}</td>
                        <td>${user.unit || '-'}</td>
                        <td>${tanggal}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="approveUser('${user.username}')">
                                <i class="bi bi-check-circle"></i> Approve
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="rejectUser('${user.username}')">
                                <i class="bi bi-x-circle"></i> Reject
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        async function approveUser(username) {
            if (!confirm(`Approve registrasi user ${username}?`)) return;

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/users/${username}/approve`, {
                    method: 'PUT'
                });
                const data = await res.json();
                alert(data.message || 'User berhasil di-approve');
                loadPendingUsers();
            } catch (err) {
                alert('Error: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        async function rejectUser(username) {
            if (!confirm(`Reject registrasi user ${username}?`)) return;

            showLoading();
            try {
                const res = await fetch(`${API_BASE_URL}/api/users/${username}/reject`, {
                    method: 'PUT'
                });
                const data = await res.json();
                alert(data.message || 'User berhasil di-reject');
                loadPendingUsers();
            } catch (err) {
                alert('Error: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        // ==========================================
        // FEATURE: SIMOPS RISK CONTROL FUNCTIONS
        // ==========================================

        let currentSimopsArea = '';
        let currentConflictJobs = [];

        // Show Ganti Jam Modal
        function showGantiJamModal(area, conflictJobsJson) {
            currentSimopsArea = area;
            currentConflictJobs = JSON.parse(decodeURIComponent(conflictJobsJson));

            document.getElementById('gantiJamArea').innerText = area;

            // Build form for each conflicting job
            let html = '<div class="table-responsive"><table class="table table-bordered">';
            html += '<thead class="table-light"><tr><th>PT/Perusahaan</th><th>Pekerjaan</th><th>Jam Saat Ini</th><th>Jam Mulai Baru</th><th>Jam Selesai Baru</th></tr></thead>';
            html += '<tbody>';

            currentConflictJobs.forEach((job, idx) => {
                html += `<tr>
                    <td><strong>${job.namaPT}</strong></td>
                    <td>${job.pekerjaan}</td>
                    <td><span class="badge bg-danger">${job.jamMulai} - ${job.jamSelesai}</span></td>
                    <td><input type="time" class="form-control form-control-sm jam-mulai-baru" data-job-id="${job.id}" value="${job.jamMulai}"></td>
                    <td><input type="time" class="form-control form-control-sm jam-selesai-baru" data-job-id="${job.id}" value="${job.jamSelesai}"></td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            html += '<div class="alert alert-warning mt-2 small"><i class="bi bi-lightbulb"></i> <strong>Tips:</strong> Ubah jam kerja agar tidak tumpang tindih antar pekerjaan di area yang sama.</div>';

            document.getElementById('gantiJamContainer').innerHTML = html;
            new bootstrap.Modal(document.getElementById('gantiJamModal')).show();
        }

        // Submit Ganti Jam
        async function submitGantiJam() {
            const changes = [];
            const jamMulaiInputs = document.querySelectorAll('.jam-mulai-baru');
            const jamSelesaiInputs = document.querySelectorAll('.jam-selesai-baru');

            // 1. Ambil data input
            jamMulaiInputs.forEach((input, idx) => {
                changes.push({
                    jobId: input.dataset.jobId,
                    jamMulai: input.value,
                    jamSelesai: jamSelesaiInputs[idx].value
                });
            });

            // 2. Validasi Tumpang Tindih (Overlap)
            let stillOverlap = false;
            for (let i = 0; i < changes.length; i++) {
                for (let j = i + 1; j < changes.length; j++) {
                    if (isOverlap(changes[i].jamMulai, changes[i].jamSelesai, changes[j].jamMulai, changes[j].jamSelesai)) {
                        stillOverlap = true;
                        break;
                    }
                }
            }

            if (stillOverlap) {
                if (!confirm('Peringatan: Jam yang diubah masih tumpang tindih! Apakah Anda yakin ingin menyimpan?')) {
                    return;
                }
            }

            showLoading();
            try {
                // 3. Generate ID di Frontend
                const newSimopsId = generateSimopsId();

                // 4. Kirim Data ke Backend (sertakan idSimops)
                const res = await fetch(`${API_BASE_URL}/api/simops`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        idSimops: newSimopsId, // ID dikirim dari sini
                        area: currentSimopsArea,
                        konflikJobs: currentConflictJobs.map(j => j.namaPT).join(', '),
                        apdTambahan: [],
                        gabunganRisk: { type: 'Ganti Jam', changes: changes }
                    })
                });

                if (res.ok) {
                    // Update detail jam per pekerjaan
                    for (const change of changes) {
                        await fetch(`${API_BASE_URL}/api/simops/mitigasi-ganti-jam`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                simopsId: newSimopsId,
                                area: currentSimopsArea,
                                changes: [change]
                            })
                        });
                    }

                    // 5. Sukses -> Tutup Modal Ganti Jam -> Buka Modal Residual
                    hideLoading();
                    bootstrap.Modal.getInstance(document.getElementById('gantiJamModal')).hide();

                    // Panggil fungsi buka modal residual (Pastikan fungsi openResidualModal sudah ada)
                    openResidualModal(newSimopsId);

                } else {
                    alert('Gagal menyimpan perubahan');
                    hideLoading();
                }
            } catch (err) {
                alert('Error: ' + err.message);
                hideLoading();
            }
        }

        // Show Mitigasi Lainnya Modal
        function showMitigasiLainnyaModal(area, conflictJobsJson) {
            currentSimopsArea = area;
            currentConflictJobs = JSON.parse(decodeURIComponent(conflictJobsJson));

            document.getElementById('mitigasiArea').innerText = area;

            // Reset form
            document.getElementById('soContainer').innerHTML = `
                <div class="input-group mb-2">
                    <input type="text" class="form-control so-input" placeholder="Nama SO 1">
                    <button type="button" class="btn btn-outline-success" onclick="addSOInput()">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>`;
            document.getElementById('siContainer').innerHTML = `
                <div class="input-group mb-2">
                    <input type="text" class="form-control si-input" placeholder="Nama SI 1">
                    <button type="button" class="btn btn-outline-success" onclick="addSIInput()">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>`;
            document.getElementById('mitigasiLeader').value = '';
            document.getElementById('mitigasiJumlahPekerja').value = '';

            // Show jobs involved
            let jobsHtml = '';
            currentConflictJobs.forEach(job => {
                jobsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><strong>${job.namaPT}</strong> - ${job.pekerjaan}</span>
                    <span class="badge bg-secondary">${job.jamMulai} - ${job.jamSelesai}</span>
                </li>`;
            });
            document.getElementById('mitigasiJobsList').innerHTML = jobsHtml;

            new bootstrap.Modal(document.getElementById('mitigasiLainnyaModal')).show();
        }

        // Add SO Input field
        function addSOInput() {
            const container = document.getElementById('soContainer');
            const count = container.querySelectorAll('.so-input').length + 1;
            const newInput = document.createElement('div');
            newInput.className = 'input-group mb-2';
            newInput.innerHTML = `
                <input type="text" class="form-control so-input" placeholder="Nama SO ${count}">
                <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
                    <i class="bi bi-trash"></i>
                </button>`;
            container.appendChild(newInput);
        }

        // Add SI Input field
        function addSIInput() {
            const container = document.getElementById('siContainer');
            const count = container.querySelectorAll('.si-input').length + 1;
            const newInput = document.createElement('div');
            newInput.className = 'input-group mb-2';
            newInput.innerHTML = `
                <input type="text" class="form-control si-input" placeholder="Nama SI ${count}">
                <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
                    <i class="bi bi-trash"></i>
                </button>`;
            container.appendChild(newInput);
        }

        // Submit Mitigasi Lainnya
        async function submitMitigasiLainnya() {
            // 1. Ambil Data Input
            const soInputs = document.querySelectorAll('.so-input');
            const namaSO = [];
            soInputs.forEach(input => { if (input.value.trim()) namaSO.push(input.value.trim()); });

            const siInputs = document.querySelectorAll('.si-input');
            const namaSI = [];
            siInputs.forEach(input => { if (input.value.trim()) namaSI.push(input.value.trim()); });

            const leader = document.getElementById('mitigasiLeader').value.trim();
            const jumlahPekerja = parseInt(document.getElementById('mitigasiJumlahPekerja').value) || 0;

            // 2. Validasi Input
            if (namaSO.length === 0) return alert('Minimal harus ada 1 Safety Officer (SO)!');
            if (!leader) return alert('Leader/Koordinator harus diisi!');

            showLoading();
            try {
                // 3. Generate ID di Frontend
                const newSimopsId = generateSimopsId();

                // 4. Kirim Data ke Backend (sertakan idSimops)
                const simopsRes = await fetch(`${API_BASE_URL}/api/simops`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        idSimops: newSimopsId, // ID dikirim dari sini
                        area: currentSimopsArea,
                        konflikJobs: currentConflictJobs.map(j => j.namaPT).join(', '),
                        apdTambahan: [],
                        gabunganRisk: {
                            type: 'Mitigasi Lainnya',
                            namaSO: namaSO,
                            namaSI: namaSI,
                            leader: leader,
                            jumlahPekerja: jumlahPekerja
                        }
                    })
                });

                if (simopsRes.ok) {
                    // Simpan detail mitigasi
                    await fetch(`${API_BASE_URL}/api/simops/mitigasi-lainnya`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            simopsId: newSimopsId,
                            area: currentSimopsArea,
                            namaSO: namaSO,
                            namaSI: namaSI,
                            leader: leader,
                            jumlahPekerja: jumlahPekerja
                        })
                    });

                    // 5. Sukses -> Tutup Modal Mitigasi -> Buka Modal Residual
                    hideLoading();
                    bootstrap.Modal.getInstance(document.getElementById('mitigasiLainnyaModal')).hide();

                    // Panggil fungsi buka modal residual
                    openResidualModal(newSimopsId);

                } else {
                    alert('Gagal menyimpan data mitigasi');
                    hideLoading();
                }
            } catch (err) {
                alert('Error: ' + err.message);
                hideLoading();
            }
        }
    </script>
</body>

</html>